<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>学生上课外出申请（公假外出）</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">

<style>
  :root{ --blue:#1a73e8;--muted:#777;--danger:#c62828;--border:#e5e5e5; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f4f6fb;color:#1f2933;line-height:1.6}
  .app-shell{max-width:1160px;margin:0 auto;padding:20px 16px 64px}
  h1{font-size:24px;margin:0;color:#0f172a}
  .app-header{position:sticky;top:0;background:linear-gradient(180deg,#f4f6fb 0%,rgba(244,246,251,0.9) 100%);backdrop-filter:blur(6px);z-index:50;padding-bottom:16px;margin-bottom:20px;border-bottom:1px solid rgba(15,23,42,.08)}
  .header-bar{display:flex;flex-wrap:wrap;align-items:center;gap:16px;justify-content:space-between}
  .tab-bar{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
  .tab{padding:8px 14px;border:1px solid #d7deed;border-radius:999px;cursor:pointer;background:#fff;color:#1f2933;box-shadow:0 1px 2px rgba(15,23,42,.04)}
  .tab:hover{border-color:var(--blue);color:var(--blue)}
  .tab.active{background:var(--blue);color:#fff;border-color:var(--blue);box-shadow:0 6px 18px rgba(26,115,232,.18)}
  .lang-switch{display:flex;align-items:center;gap:8px;color:#52616b;font-size:14px}
  .lang-switch select{min-width:140px;padding:6px 10px;border-radius:999px;border:1px solid #cfd8e3;background:#fff;font-size:14px}
  .app-main{display:flex;flex-direction:column;gap:18px}
  .card{border:1px solid #e0e7ff;border-radius:16px;padding:18px;margin-bottom:0;background:#fff;box-shadow:0 18px 36px -24px rgba(15,23,42,.32)}
  .card + .card{margin-top:16px}
  label{display:inline-block;min-width:88px}
  input,select,button,textarea{padding:8px 10px;border:1px solid #cfd8e3;border-radius:10px;background:#fff;font-size:14px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,115,232,.12)}
  button:focus-visible{outline:2px solid rgba(26,115,232,.45);outline-offset:3px}
  .row{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0}
  .grow{flex:1 1 220px}
  .btn{background:var(--blue);color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:none}
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px -12px rgba(26,115,232,.7)}
  .btn.secondary{background:#475569}
  .btn.ghost{background:#fff;color:#1f2933;border:1px solid #cfd8e3}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .list{border:1px dashed #d7deed;border-radius:12px;padding:12px;background:#f8faff}
  .chips{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border:1px dashed #d7deed;border-radius:14px;background:#f8faff}
  .chip{display:inline-flex;align-items:center;border:1px solid #cfd8e3;border-radius:999px;padding:4px 10px;background:#fff;gap:6px;font-size:13px;box-shadow:0 6px 18px -16px rgba(15,23,42,.35)}
  .chip button{margin-left:0;border:none;background:transparent;color:var(--danger);cursor:pointer;font-weight:600;padding:2px 4px;border-radius:6px;transition:background .15s ease}
  .chip button:hover{background:rgba(198,40,40,.1)}
  .suggest{position:relative}
  .suggest-list{position:absolute;z-index:20;background:#fff;border:1px solid #d7deed;border-radius:12px;width:100%;max-height:240px;overflow:auto;box-shadow:0 20px 40px -20px rgba(15,23,42,.35);padding:6px}
  .suggest-item{padding:8px 10px;border-radius:10px;cursor:pointer;transition:background .15s ease,color .15s ease}
  .suggest-item:hover,.suggest-item.active{background:#f0f6ff;color:#1a73e8}
  #ghostNameHint{color:#aaa;font-size:12px;margin-top:2px}
  textarea{width:100%;min-height:110px;border-radius:14px;resize:vertical}
  textarea[readonly]{background:#f9fbff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #e8ecf8;padding:10px 12px;text-align:left;vertical-align:top}
  th{position:sticky;top:0;background:#f0f4ff;z-index:1;font-weight:600;color:#1f2933}
  tbody tr:nth-child(even){background:#f9fbff}
  tbody tr:hover{background:#eef4ff}
  .nowrap{white-space:nowrap}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #ccc;border-radius:999px;font-size:12px}
  .scroll-x{overflow:auto;border-radius:16px}
  @media (max-width:640px){
    .app-shell{padding:16px 12px 48px}
    h1{font-size:20px}
    .tab-bar{gap:8px}
    .tab{flex:1 1 auto}
    label{min-width:72px}
    .row{gap:8px}
    input,select,button,textarea{font-size:16px}
    th,td{padding:8px}
    .tabs{position:sticky;top:0;background:#fff;padding-top:6px;z-index:10}
  }
  /* 监看-时间表 */
  .ttable{border:1px solid #eee;border-radius:8px;overflow:auto}
  .ttable table{min-width:1100px}
  .ttable th,.ttable td{border:1px solid #efefef}
  .ttable thead th{position:sticky;top:0;background:#fafafa;z-index:2}
  .ttable tbody th{position:sticky;left:0;background:#fafafa;z-index:1}
  .cell{min-width:180px}
  .cell .slot{margin-bottom:6px}
  .cell .slot-title{font-weight:600}
  .cell .students{font-size:12px;color:#555}
</style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="header-bar">
      <h1 id="appTitle" data-i18n-text="appTitle">学生上课外出申请（公假外出）</h1>
      <label class="lang-switch">
        <span data-i18n-text="languageLabel">界面语言：</span>
        <select id="languageSelect">
          <option value="zh" data-i18n-text="languageOptionZh">简体中文</option>
          <option value="en" data-i18n-text="languageOptionEn">English</option>
        </select>
      </label>
    </div>
    <div class="tab-bar" role="tablist">
      <button type="button" class="tab active" id="tab-monitor" data-tab="monitor" data-i18n-text="tabMonitor" role="tab" aria-controls="page-monitor" aria-selected="true" tabindex="0">监看</button>
      <button type="button" class="tab" id="tab-apply" data-tab="apply" data-i18n-text="tabApply" role="tab" aria-controls="page-apply" aria-selected="false" tabindex="-1">申请</button>
      <button type="button" class="tab" id="tab-records" data-tab="records" data-i18n-text="tabRecords" role="tab" aria-controls="page-records" aria-selected="false" tabindex="-1">记录 / 查看</button>
    </div>
  </header>

  <main class="app-main">
  <!-- 申请页 -->
  <section id="page-apply" style="display:none;" aria-labelledby="tab-apply" role="tabpanel">
  <div class="card">
    <div class="row">
      <div class="grow">
        <label for="idQuick" data-i18n-text="labelIdQuick">学号直达：</label>
        <input id="idQuick" placeholder="输入学号后回车或点加入" data-i18n-placeholder="phIdQuick"/>
        <button class="btn ghost" id="btnAddById" data-i18n-text="btnAddById">加入名单</button>
      </div>
      <div class="grow suggest">
        <label for="nameCn" data-i18n-text="labelNameSearch">姓名模糊搜：</label>
        <input id="nameCn" autocomplete="off" placeholder="中文/英文/拼音…" data-i18n-placeholder="phNameSearch"/>
        <div id="suggestList" class="suggest-list" style="display:none;"></div>
        <div id="ghostNameHint"></div>
      </div>
    </div>
    <div class="row">
      <div class="grow">
        <label for="idsBulk" data-i18n-text="labelIdsBulk">批量学号：</label>
        <textarea id="idsBulk" placeholder="支持逗号、空格、换行分隔" data-i18n-placeholder="phIdsBulk"></textarea>
      </div>
      <div class="grow">
        <button class="btn" id="btnAddBulk" data-i18n-text="btnAddBulk">批量加入名单</button>
        <button class="btn ghost" id="btnClearList" data-i18n-text="btnClearList">清空名单</button>
      </div>
    </div>
    <div class="row">
      <div class="grow">
        <label data-i18n-text="labelCurrentList">本次名单：</label>
        <div id="chips" class="chips"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="grow">
        <label for="applyDatePicker" data-i18n-text="labelDateSelect">日期选择：</label>
        <input type="date" id="applyDatePicker"/>
        <input type="checkbox" id="autoAddDate" checked style="margin-left:6px"/> <span class="muted" data-i18n-text="hintAutoAddDate">选择后自动加入</span>
        <div style="margin-top:6px"></div>
        <label style="min-width:auto" for="applyDatePickerStart" data-i18n-text="labelStartDate">起：</label><input type="date" id="applyDatePickerStart"/>
        <label style="min-width:auto" for="applyDatePickerEnd" data-i18n-text="labelEndDate">止：</label><input type="date" id="applyDatePickerEnd"/>
        <button class="btn ghost" id="btnAddRange" data-i18n-text="btnAddDateRange">加入范围</button>
        <div style="margin-top:6px"></div>
        <button class="btn ghost" id="btnAddApplyDate" data-i18n-text="btnAddSelectedDate">加入所选</button>
        <div id="applyDateChips" class="chips" style="margin-top:6px"></div>
      </div>
      <div class="grow">
        <label for="period" data-i18n-text="labelPeriod">时间段：</label>
        <input id="period" placeholder="如：第3-4节 或 10:00-11:30" data-i18n-placeholder="phPeriod"/>
      </div>
      <div class="grow">
        <label for="activity" data-i18n-text="labelActivity">活动名称：</label>
        <input id="activity" placeholder="如：全州排球赛" data-i18n-placeholder="phActivity"/>
      </div>
    </div>
    <div id="conflict" class="muted"></div>
    <div class="row">
      <button class="btn" id="btnGenText" data-i18n-text="btnGenerateText">生成中英文本</button>
      <button class="btn ghost" id="btnSave" data-i18n-text="btnSaveToRecords">保存到记录</button>
    </div>
  </div>

  <div id="output" class="card" style="display:none;">
    <div class="row"><strong data-i18n-text="labelCnNotice">中文通知：</strong></div>
    <textarea id="outCn" readonly></textarea>
    <div class="row"><strong data-i18n-text="labelEnNotice">English Letter:</strong></div>
    <textarea id="outEn" readonly></textarea>
    <div class="row">
      <button class="btn ghost" id="btnCopyCn" data-i18n-text="btnCopyCn">复制中文TXT</button>
      <button class="btn ghost" id="btnCopyEn" data-i18n-text="btnCopyEn">复制英文TXT</button>
    </div>
  </div>

  <div class="card">
    <div><strong data-i18n-text="labelSubmitPassword">提交前简单密码</strong>：<span class="pill">123456</span></div>
    <div class="row">
      <label for="pwd" data-i18n-text="labelPassword">密码：</label><input type="password" id="pwd"/>
    </div>
  </div>
  </section>

  <!-- 记录/查看页 -->
  <section id="page-records" style="display:none;" aria-labelledby="tab-records" role="tabpanel">
  <div class="card">
    <div class="row">
      <div class="grow">
        <label for="fltDates" data-i18n-text="labelFilterDates">按日期筛选：</label>
        <textarea id="fltDates" placeholder="支持多日期：2025-09-25, 2025-09-26" data-i18n-placeholder="phFilterDates"></textarea>
      </div>
      <div class="grow">
        <label for="fltClass" data-i18n-text="labelFilterClass">按班级筛选：</label>
        <input id="fltClass" placeholder="如：J1Z（留空=全部）" data-i18n-placeholder="phFilterClass"/>
      </div>
      <div class="grow">
        <label for="fltQuery" data-i18n-text="labelFilterQuery">快速搜索：</label>
        <input id="fltQuery" placeholder="学号/中文/英文 关键词" data-i18n-placeholder="phFilterQuery"/>
      </div>
      <div class="grow">
        <button class="btn" id="btnExport" data-i18n-text="btnExportCsv">导出筛选CSV</button>
        <button class="btn ghost" id="btnDeleteSelected" data-i18n-text="btnDeleteSelected">删除所选记录</button>
      </div>
    </div>
  </div>
  <div class="card scroll-x">
    <table>
      <thead>
        <tr>
          <th class="nowrap"><input type="checkbox" id="chkAllRecords"/></th>
          <th class="nowrap" data-i18n-text="thDate">日期</th>
          <th class="nowrap" data-i18n-text="thPeriod">时间段</th>
          <th data-i18n-text="thStudentId">学号</th>
          <th data-i18n-text="thClass">班级</th>
          <th data-i18n-text="thNameCn">中文姓名</th>
          <th data-i18n-text="thNameEn">英文姓名</th>
          <th data-i18n-text="thActivity">活动</th>
          <th data-i18n-text="thDepartment">部门</th>
          <th class="nowrap" data-i18n-text="thActions">操作</th>
        </tr>
      </thead>
      <tbody id="tblBody"></tbody>
    </table>
  </div>
  </section>

  <!-- 监看页 -->
  <section id="page-monitor" aria-labelledby="tab-monitor" role="tabpanel">
  <div class="card">
    <div class="row">
      <div class="grow">
        <label for="monDatePicker" data-i18n-text="labelMonitorDates">日期选择：</label>
        <input type="date" id="monDatePicker"/>
        <input type="checkbox" id="autoAddMonDate" checked style="margin-left:6px"/> <span class="muted" data-i18n-text="hintAutoAddMonDate">选择后自动加入</span>
        <div style="margin-top:6px"></div>
        <label style="min-width:auto" for="monDatePickerStart" data-i18n-text="labelStartDate">起：</label><input type="date" id="monDatePickerStart"/>
        <label style="min-width:auto" for="monDatePickerEnd" data-i18n-text="labelEndDate">止：</label><input type="date" id="monDatePickerEnd"/>
        <button class="btn ghost" id="btnAddMonRange" data-i18n-text="btnAddDateRange">加入范围</button>
        <div style="margin-top:6px"></div>
        <button class="btn ghost" id="btnAddMonDate" data-i18n-text="btnAddSelectedDate">加入所选</button>
        <div id="monDateChips" class="chips" style="margin-top:6px"></div>
      </div>
      <div class="grow">
        <label for="monTeacher" data-i18n-text="labelMonitorTeacher">老师筛选：</label>
        <select id="monTeacher"><option value="">（全部老师）</option></select>
      </div>
      <div class="grow">
        <label for="monClass" data-i18n-text="labelMonitorClass">班级筛选：</label>
        <select id="monClass"><option value="">（全部班级）</option></select>
      </div>
      <div class="grow">
        <label for="monMode" data-i18n-text="labelMonitorMode">显示模式：</label>
        <select id="monMode">
          <option value="timetable" selected data-i18n-text="optionMonitorTimetable">时间表</option>
          <option value="table" data-i18n-text="optionMonitorTable">表格</option>
          <option value="cards" data-i18n-text="optionMonitorCards">卡片</option>
        </select>
      </div>
      <div class="grow">
        <button class="btn" id="btnMonRefresh" data-i18n-text="btnMonitorRefresh">刷新</button>
        <button class="btn ghost" id="btnMonExport" data-i18n-text="btnMonitorExport">导出当前视图CSV</button>
      </div>
    </div>
    <div class="muted" data-i18n-text="monitorHint">说明：① 多日期可同时监看；② 初中（J…）英/马/数分组课严格按 h/i/f 精确匹配；③ 未提供课表将仅显示记录。</div>
  </div>
  <div class="card scroll-x" id="monResult"></div>
  <div class="card mon-reason-panel" id="monReasonPanel" style="display:none;"></div>
  </section>

  </main>
</div>

<!-- 业务脚本（ESM） -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  // 1) 初始化 Supabase（放最前）
  const SUPABASE_URL = "https://ktgrbbzpqfuiprpkbtbk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0Z3JiYnpwcWZ1aXBycGtidGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjkzMTQsImV4cCI6MjA3NDkwNTMxNH0.Ik-rT3rqGRx1PUYBd41ZofQf90H0v8vru67dv7ktNvs";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /***** —— 2) 全局变量 —— *****/
  const DEPARTMENT_PASSWORDS=[
    { code:'cca', cn:'联课处', en:'Co-Curricular Department', passwords:['666666'] },
    { code:'vp', cn:'副校长', en:'Vice Principal',passwords:['870816']},
    // 如需新增部门，请在此数组增加配置项，并把 passwords 改成该部门专属密码列表
  ];
  let students=[];     // {id, cn, en, class, pinyin?, eng?, bm?, math?}
  let schedule=[];     // {class, weekday, period, subject, subject_en?, teacher, teacher_en?, group?, subject_id?, teacher_id?}
  const subjectsById=new Map();
  const teachersById=new Map();
  const subjectEnMapByCn=Object.create(null);
  const teacherEnMapByCn=Object.create(null);
  let pickList=[];     // {id, cn, en, class}
  let applyDates=[];   // 申请多日期
  let monDates=[];     // 监看多日期
  let hasUnsavedChanges=false; // 申请表单是否存在未保存修改
  let monitorDefaultInitialized=false;
  let monitorDefaultActive=false;
  let monitorUserModified=false;
  let deleteAuthCache=null; // { dept, ts }
  const DELETE_AUTH_CACHE_MS=10*60*1000; // 10 分钟内复用验证

  /***** —— 语言与国际化 —— *****/
  const translations={
    zh:{
      pageTitle:"学生上课外出申请（公假外出）",
      appTitle:"学生上课外出申请（公假外出）",
      tabApply:"申请",
      tabRecords:"记录 / 查看",
      tabMonitor:"监看",
      languageLabel:"界面语言：",
      languageOptionZh:"简体中文",
      languageOptionEn:"English",
      labelIdQuick:"学号直达：",
      btnAddById:"加入名单",
      labelNameSearch:"姓名模糊搜：",
      labelIdsBulk:"批量学号：",
      btnAddBulk:"批量加入名单",
      btnClearList:"清空名单",
      labelCurrentList:"本次名单：",
      labelDateSelect:"日期选择：",
      hintAutoAddDate:"选择后自动加入",
      labelStartDate:"起：",
      labelEndDate:"止：",
      btnAddDateRange:"加入范围",
      btnAddSelectedDate:"加入所选",
      labelPeriod:"时间段：",
      labelActivity:"活动名称：",
      btnGenerateText:"生成中英文本",
      btnSaveToRecords:"保存到记录",
      labelCnNotice:"中文通知：",
      labelEnNotice:"English Letter:",
      btnCopyCn:"复制中文TXT",
      btnCopyEn:"复制英文TXT",
      labelSubmitPassword:"提交前简单密码",
      labelPassword:"密码：",
      labelFilterDates:"按日期筛选：",
      btnExportCsv:"导出筛选CSV",
      btnDeleteSelected:"删除所选记录",
      labelFilterClass:"按班级筛选：",
      labelFilterQuery:"快速搜索：",
      thDate:"日期",
      thPeriod:"时间段",
      thStudentId:"学号",
      thClass:"班级",
      thNameCn:"中文姓名",
      thNameEn:"英文姓名",
      thActivity:"活动",
      thDepartment:"部门",
      thActions:"操作",
      labelMonitorDates:"日期选择：",
      hintAutoAddMonDate:"选择后自动加入",
      labelMonitorTeacher:"老师筛选：",
      labelMonitorClass:"班级筛选：",
      labelMonitorMode:"显示模式：",
      optionMonitorTimetable:"时间表",
      optionMonitorTable:"表格",
      optionMonitorCards:"卡片",
      btnMonitorRefresh:"刷新",
      btnMonitorExport:"导出当前视图CSV",
      monitorHint:"说明：① 多日期可同时监看；② 初中（J…）英/马/数分组课严格按 h/i/f 精确匹配；③ 未提供课表将仅显示记录。",
      monitorCardTeacherLabel:"任课：",
      monitorCardStudentsLabel:"外出学生：",
      monitorCardNoStudents:"（无）",
      phIdQuick:"输入学号后回车或点加入",
      phNameSearch:"中文/英文/拼音…",
      ghostPreselect:"预选：{id} / {cn} / {en} / {class}",
      phIdsBulk:"支持逗号、空格、换行分隔",
      phPeriod:"如：第3-4节 或 10:00-11:30",
      phActivity:"如：全州排球赛",
      phFilterDates:"支持多日期：2025-09-25, 2025-09-26",
      phFilterClass:"如：J1Z（留空=全部）",
      phFilterQuery:"学号/中文/英文 关键词",
      optionAllTeachers:"（全部老师）",
      optionAllClasses:"（全部班级）",
      errorLoadCoreData:"加载学生/课表数据失败，请稍后再试。",
      studentIdLabel:"学号 {id}",
      unnamedStudent:"未命名学生",
      reasonFallback:"未提供理由",
      monitorReasonTitle:"外出学生",
      monitorDepartmentPrefix:"部门：",
      reasonLabel:"事由：",
      btnClose:"关闭",
      promptDeletionPassword:"请输入{action}密码（同提交密码）：",
      errorPasswordIncorrect:"密码不正确",
      errorEnterStudentId:"请先输入学号。",
      errorStudentNotFound:"未找到该学号的学生。",
      errorEnterIdsFirst:"请先填写学号。",
      bulkAddSummaryWithMissing:"成功加入 {count} 人，以下学号未匹配：{missing}",
      bulkAddSummary:"成功加入 {count} 人。",
      errorSelectRange:"请先选择起止日期。",
      errorRangeOrder:"开始日期不能晚于结束日期。",
      conflictWeekend:"所选日期为周末，无课表。",
      conflictNoPeriods:"无法识别时间段，请检查格式。",
      conflictSummaryTitle:"冲堂课程（已按分组精准匹配）",
      conflictNoLessons:"所选时间段无对应课程。",
      errorNeedList:"请先加入至少一名学生。",
      errorNeedDate:"请先加入至少一个日期。",
      errorNeedPeriod:"请输入时间段。",
      errorNeedActivity:"请输入活动名称。",
      saveSuccess:"已保存 {count} 条记录。",
      saveNothing:"没有可保存的记录。",
      saveFailed:"保存失败，请稍后再试。",
      copyCnSuccess:"已复制中文文本。",
      copyEnSuccess:"已复制英文文本。",
      copyFailed:"复制失败：{message}",
      copyEnFailed:"复制英文文本失败：{message}",
      errorFetchRecords:"加载记录失败，请稍后再试。",
      deleteRecords:"删除记录",
      errorMissingDeleteKeys:"缺少定位字段，无法删除。",
      confirmDeleteSingle:"确认删除 {date} {studentId} 这条记录？",
      errorDeleteFailed:"删除失败，请稍后再试。",
      errorDeletePartial:"删除过程中出现错误，部分记录可能未被删除。",
      alertSelectRecords:"请先选择需要删除的记录。",
      confirmDeleteSelected:"确定删除选中的 {count} 条记录？此操作不可恢复。",
      successDelete:"已删除所选记录。",
      exportEmpty:"无可导出的内容。",
      errorMonitorRange:"请先选择监看起止日期。",
      errorMonitorNeedDate:"请先加入至少一个监看日期。",
      errorMonitorFetch:"加载监看数据失败。",
      monitorNoResults:"无匹配记录。",
      monitorNoResultsShort:"无匹配记录",
      monitorNoMissing:"暂无缺失学生。",
      monitorTablePeriodColumn:"节次/时间",
      monitorTableGroupColumn:"分组",
      monitorTableSubjectColumn:"科目",
      monitorTableTeacherColumn:"任课老师",
      monitorTableStudentsColumn:"外出学生",
      monitorTimetableWeekdayHeading:"星期",
      monitorUnmatchedLabel:"未匹配课表：",
      monitorUnmatchedRecordsLabel:"未匹配课表记录：",
      monitorSpecificSlot:"具体时段",
      monitorNoSchedule:"（无课表）",
      monitorGroupLabel:"{group}组",
      monitorPeriodLabel:"第{period}节",
      monitorExportFilename:"监看视图.csv"
      ,
      exportRecordsFilename:"外出申请记录_筛选.csv"
    },
    en:{
      pageTitle:"Student Official Leave Application",
      appTitle:"Student Official Leave Application",
      tabApply:"Apply",
      tabRecords:"Records / Review",
      tabMonitor:"Monitor",
      languageLabel:"Interface language:",
      languageOptionZh:"Simplified Chinese",
      languageOptionEn:"English",
      labelIdQuick:"Student ID quick add:",
      btnAddById:"Add to list",
      labelNameSearch:"Name search:",
      labelIdsBulk:"Student IDs (bulk):",
      btnAddBulk:"Add all to list",
      btnClearList:"Clear list",
      labelCurrentList:"Current list:",
      labelDateSelect:"Pick dates:",
      hintAutoAddDate:"Auto-add after selecting",
      labelStartDate:"Start:",
      labelEndDate:"End:",
      btnAddDateRange:"Add range",
      btnAddSelectedDate:"Add selected",
      labelPeriod:"Time slot:",
      labelActivity:"Activity name:",
      btnGenerateText:"Generate CN/EN text",
      btnSaveToRecords:"Save to records",
      labelCnNotice:"Chinese notice:",
      labelEnNotice:"English letter:",
      btnCopyCn:"Copy Chinese TXT",
      btnCopyEn:"Copy English TXT",
      labelSubmitPassword:"Submit password",
      labelPassword:"Password:",
      labelFilterDates:"Filter by dates:",
      btnExportCsv:"Export filtered CSV",
      btnDeleteSelected:"Delete selected records",
      labelFilterClass:"Filter by class:",
      labelFilterQuery:"Quick search:",
      thDate:"Date",
      thPeriod:"Period",
      thStudentId:"Student ID",
      thClass:"Class",
      thNameCn:"Name (CN)",
      thNameEn:"Name (EN)",
      thActivity:"Activity",
      thDepartment:"Department",
      thActions:"Actions",
      labelMonitorDates:"Pick dates:",
      hintAutoAddMonDate:"Auto-add after selecting",
      labelMonitorTeacher:"Filter by teacher:",
      labelMonitorClass:"Filter by class:",
      labelMonitorMode:"Display mode:",
      optionMonitorTimetable:"Timetable",
      optionMonitorTable:"Table",
      optionMonitorCards:"Cards",
      btnMonitorRefresh:"Refresh",
      btnMonitorExport:"Export current view CSV",
      monitorHint:"Notes: (1) Multiple dates can be monitored at once. (2) For junior (J...) English/BM/Math split classes, match the h/i/f groups exactly. (3) When no timetable is available, only records are shown.",
      monitorCardTeacherLabel:"Teacher: ",
      monitorCardStudentsLabel:"Students: ",
      monitorCardNoStudents:"(None)",
      phIdQuick:"Enter student ID then press Enter or Add",
      phNameSearch:"Chinese/English/Pinyin…",
      ghostPreselect:"Preview: {id} / {cn} / {en} / {class}",
      phIdsBulk:"Comma, space or newline separated IDs",
      phPeriod:"e.g. Period 3-4 or 10:00-11:30",
      phActivity:"e.g. State volleyball meet",
      phFilterDates:"Multiple dates allowed: 2025-09-25, 2025-09-26",
      phFilterClass:"e.g. J1Z (leave empty = all)",
      phFilterQuery:"Student ID / CN / EN keywords",
      optionAllTeachers:"All teachers",
      optionAllClasses:"All classes",
      errorLoadCoreData:"Failed to load students/timetable. Please try again later.",
      studentIdLabel:"ID {id}",
      unnamedStudent:"Unnamed student",
      reasonFallback:"No reason provided",
      monitorReasonTitle:"Student",
      monitorDepartmentPrefix:"Department: ",
      reasonLabel:"Reason:",
      btnClose:"Close",
      promptDeletionPassword:"Enter password for {action} (same as submit password):",
      errorPasswordIncorrect:"Incorrect password",
      errorEnterStudentId:"Please enter a student ID first.",
      errorStudentNotFound:"No student found with that ID.",
      errorEnterIdsFirst:"Please enter the student IDs first.",
      bulkAddSummaryWithMissing:"Added {count} students. These IDs were not found: {missing}",
      bulkAddSummary:"Added {count} students.",
      errorSelectRange:"Please select start and end dates first.",
      errorRangeOrder:"Start date cannot be after end date.",
      conflictWeekend:"Selected date falls on a weekend; no timetable available.",
      conflictNoPeriods:"Could not parse the time slot. Check the format.",
      conflictSummaryTitle:"Conflicting lessons (matched by split group)",
      conflictNoLessons:"No scheduled lessons for the selected slot.",
      errorNeedList:"Add at least one student first.",
      errorNeedDate:"Add at least one date first.",
      errorNeedPeriod:"Enter a time slot.",
      errorNeedActivity:"Enter the activity name.",
      saveSuccess:"Saved {count} records.",
      saveNothing:"Nothing to save.",
      saveFailed:"Failed to save. Please try again.",
      copyCnSuccess:"Chinese text copied.",
      copyEnSuccess:"English text copied.",
      copyFailed:"Copy failed: {message}",
      copyEnFailed:"Failed to copy English text: {message}",
      errorFetchRecords:"Failed to load records. Please try again.",
      deleteRecords:"Delete record",
      errorMissingDeleteKeys:"Missing required keys for deletion.",
      confirmDeleteSingle:"Delete the record for {date} {studentId}?",
      errorDeleteFailed:"Failed to delete. Please try again.",
      errorDeletePartial:"An error occurred during deletion; some records may remain.",
      alertSelectRecords:"Select records to delete first.",
      confirmDeleteSelected:"Delete the {count} selected records? This action cannot be undone.",
      successDelete:"Selected records deleted.",
      exportEmpty:"Nothing to export.",
      errorMonitorRange:"Select start and end dates for monitoring first.",
      errorMonitorNeedDate:"Add at least one monitoring date first.",
      errorMonitorFetch:"Failed to load monitor data.",
      monitorNoResults:"No matching records.",
      monitorNoResultsShort:"No matches",
      monitorNoMissing:"No missing students.",
      monitorTablePeriodColumn:"Period / Time",
      monitorTableGroupColumn:"Group",
      monitorTableSubjectColumn:"Subject",
      monitorTableTeacherColumn:"Teacher",
      monitorTableStudentsColumn:"Students out",
      monitorTimetableWeekdayHeading:"Weekday",
      monitorUnmatchedLabel:"Not matched to timetable:",
      monitorUnmatchedRecordsLabel:"Records without timetable match:",
      monitorSpecificSlot:"Specific time",
      monitorNoSchedule:"(No timetable)",
      monitorGroupLabel:"Group {group}",
      monitorPeriodLabel:"Period {period}",
      monitorExportFilename:"monitor-view.csv",
      exportRecordsFilename:"leave-records_filtered.csv"
    }
  };
  const LANGUAGE_STORAGE_KEY='leave_app_lang';
  const DEFAULT_LANGUAGE='zh';
  const FALLBACK_LANGUAGE='zh';
  const languageChangeCallbacks=new Set();

  function safeStorageGet(key){
    try{ return localStorage.getItem(key); }
    catch(err){ return null; }
  }
  function safeStorageSet(key,value){
    try{ localStorage.setItem(key,value); }
    catch(err){ /* ignore */ }
  }

  function normalizeLanguageTag(tag){
    if(!tag) return '';
    const lower=String(tag).toLowerCase();
    if(lower.startsWith('zh')) return 'zh';
    if(lower.startsWith('en')) return 'en';
    return '';
  }

  function detectInitialLanguage(){
    const stored=normalizeLanguageTag(safeStorageGet(LANGUAGE_STORAGE_KEY));
    if(stored && translations[stored]) return stored;
    const docLang=normalizeLanguageTag(document?.documentElement?.lang);
    if(docLang && translations[docLang]) return docLang;
    const navLang=normalizeLanguageTag((navigator.languages && navigator.languages[0]) || navigator.language);
    if(navLang && translations[navLang]) return navLang;
    return DEFAULT_LANGUAGE;
  }

  function formatTranslation(template,params){
    if(!params) return template;
    return template.replace(/\{(\w+)\}/g,(match,key)=>{
      if(Object.prototype.hasOwnProperty.call(params,key)){
        const val=params[key];
        return val==null?'' : String(val);
      }
      return match;
    });
  }

  let currentLanguage=detectInitialLanguage();

  function t(key,params){
    const dict=translations[currentLanguage] || {};
    let template=dict[key];
    if(template==null){
      template=translations[FALLBACK_LANGUAGE]?.[key];
    }
    if(template==null){
      return key;
    }
    if(params && typeof params==='object'){
      return formatTranslation(template,params);
    }
    return template;
  }

  function applyTranslationsToDom(){
    if(typeof document==='undefined') return;
    document.querySelectorAll('[data-i18n-text]').forEach(el=>{
      const key=el.getAttribute('data-i18n-text');
      if(!key) return;
      el.textContent=t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key=el.getAttribute('data-i18n-placeholder');
      if(!key) return;
      const translated=t(key);
      el.setAttribute('placeholder',translated);
    });
    const selectEl=document.getElementById('languageSelect');
    if(selectEl && selectEl.value!==currentLanguage){
      selectEl.value=currentLanguage;
    }
    document.title=t('pageTitle');
  }

  function setLanguage(lang,options={}){
    const { persist=true } = options;
    let normalized=normalizeLanguageTag(lang);
    if(!translations[normalized]) normalized=DEFAULT_LANGUAGE;
    const previous=currentLanguage;
    currentLanguage=normalized;
    if(persist){
      safeStorageSet(LANGUAGE_STORAGE_KEY,currentLanguage);
    }
    if(document?.documentElement){
      document.documentElement.lang=currentLanguage==='zh'?'zh-CN':'en';
    }
    applyTranslationsToDom();
    languageChangeCallbacks.forEach(cb=>{
      try{ cb(currentLanguage,previous); }
      catch(err){ console.error('Language change callback failed:',err); }
    });
    return currentLanguage;
  }

  function onLanguageChange(callback){
    if(typeof callback==='function'){
      languageChangeCallbacks.add(callback);
    }
  }

  function getCurrentLanguage(){
    return currentLanguage;
  }

  /***** —— 3) 从 Supabase 读取学生 + 课表 —— *****/
  function buildTeacherClassSelects(){
  // 依赖：schedule、monTeacher、monClass 已经声明
  const tset = new Set(schedule.map(x=>x.teacher).filter(Boolean));
  const carr = Array.from(new Set(schedule.map(x=>x.class).filter(Boolean))).sort();
  const tarr = Array.from(tset).sort();

  const storedTeacherPref = monitorTeacherPreference ?? '';
  const currentTeacher = monTeacher.value ?? '';
  const preferredTeacher = storedTeacherPref || currentTeacher || '';
  monTeacher.innerHTML =
    `<option value="">${escapeHtml(t('optionAllTeachers'))}</option>` +
    tarr.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
  const teacherIsAvailable = preferredTeacher && tarr.includes(preferredTeacher);
  monTeacher.value = teacherIsAvailable ? preferredTeacher : '';
  monitorTeacherPreference = teacherIsAvailable ? preferredTeacher : storedTeacherPref;

  const storedClassPref = monitorClassPreference ?? '';
  const currentClass = monClass.value ?? '';
  const preferredClass = storedClassPref || currentClass || '';
  monClass.innerHTML =
    `<option value="">${escapeHtml(t('optionAllClasses'))}</option>` +
    carr.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  const classIsAvailable = preferredClass && carr.includes(preferredClass);
  monClass.value = classIsAvailable ? preferredClass : '';
  monitorClassPreference = classIsAvailable ? preferredClass : storedClassPref;
}

  const normalizeLookupKey=value=>{
    if(value==null) return '';
    const text=String(value).trim();
    return text;
  };

  function clearObject(obj){
    if(!obj) return;
    Object.keys(obj).forEach(key=>{ delete obj[key]; });
  }

  function resetLookupCaches(){
    subjectsById.clear();
    teachersById.clear();
    clearObject(subjectEnMapByCn);
    clearObject(teacherEnMapByCn);
  }

  function rememberSubjectRecord(record){
    if(!record) return;
    const cn=normalizeLookupKey(record.name_cn);
    const en=normalizeLookupKey(record.name_en);
    if(record.id!=null){
      subjectsById.set(record.id,{ cn, en });
    }
    if(cn){
      if(en){
        subjectEnMapByCn[cn]=en;
      }else if(!(cn in subjectEnMapByCn)){
        subjectEnMapByCn[cn]='';
      }
    }
  }

  function rememberTeacherRecord(record){
    if(!record) return;
    const cn=normalizeLookupKey(record.name_cn);
    const en=normalizeLookupKey(record.name_en);
    if(record.id!=null){
      teachersById.set(record.id,{ cn, en });
    }
    if(cn){
      if(en){
        teacherEnMapByCn[cn]=en;
      }else if(!(cn in teacherEnMapByCn)){
        teacherEnMapByCn[cn]='';
      }
    }
  }

  function rememberSubjectName(nameCn,nameEn){
    const cn=normalizeLookupKey(nameCn);
    if(!cn) return;
    const en=normalizeLookupKey(nameEn);
    if(en){
      subjectEnMapByCn[cn]=en;
    }else if(!(cn in subjectEnMapByCn)){
      subjectEnMapByCn[cn]='';
    }
  }

  function rememberTeacherName(nameCn,nameEn){
    const cn=normalizeLookupKey(nameCn);
    if(!cn) return;
    const en=normalizeLookupKey(nameEn);
    if(en){
      teacherEnMapByCn[cn]=en;
    }else if(!(cn in teacherEnMapByCn)){
      teacherEnMapByCn[cn]='';
    }
  }

  function getSubjectEnglishName(nameCn){
    const cn=normalizeLookupKey(nameCn);
    if(!cn) return '';
    return subjectEnMapByCn[cn] || '';
  }

  function getTeacherEnglishName(nameCn){
    const cn=normalizeLookupKey(nameCn);
    if(!cn) return '';
    return teacherEnMapByCn[cn] || '';
  }

  async function loadCoreDataFromSupabase() {
    try {
      resetLookupCaches();

      const { data: stu, error: e1 } = await supabase
        .from("students")
        .select("id,name_cn,name_en,pinyin,class,group_en,group_bm,group_math")
        .order("id");
      if (e1) throw e1;
      students = (stu || []).map(s => ({
        id: s.id,
        cn: s.name_cn || "",
        en: s.name_en || "",
        class: (s.class || "").toUpperCase(),
        pinyin: s.pinyin || "",
        eng: (s.group_en || "").toLowerCase(),
        bm: (s.group_bm || "").toLowerCase(),
        math: (s.group_math || "").toLowerCase(),
      }));

      const { data: subjectsData, error: subjectsError } = await supabase
        .from("subjects")
        .select("id,name_cn,name_en");
      if (subjectsError) {
        console.warn("[Supabase] load subjects failed:", subjectsError);
      } else {
        (subjectsData || []).forEach(rememberSubjectRecord);
      }

      const { data: subjectMapData, error: subjectMapError } = await supabase
        .from("subject_map")
        .select("name_cn,name_en");
      if (subjectMapError) {
        console.warn("[Supabase] load subject_map failed:", subjectMapError);
      } else {
        (subjectMapData || []).forEach(row => {
          rememberSubjectName(row?.name_cn, row?.name_en);
        });
      }

      const { data: teachersData, error: teachersError } = await supabase
        .from("teachers")
        .select("id,name_cn,name_en");
      if (teachersError) {
        console.warn("[Supabase] load teachers failed:", teachersError);
      } else {
        (teachersData || []).forEach(rememberTeacherRecord);
      }

      const linkMap=new Map();
      const { data: linksData, error: linksError } = await supabase
        .from("timetable_links")
        .select("timetable_id,subject_id,teacher_id,subjects(name_cn,name_en),teachers(name_cn,name_en)");
      if (linksError) {
        console.warn("[Supabase] load timetable_links failed:", linksError);
      } else {
        (linksData || []).forEach(link => {
          const subjectCnRaw = link?.subjects?.name_cn;
          const subjectEnRaw = link?.subjects?.name_en;
          const teacherCnRaw = link?.teachers?.name_cn;
          const teacherEnRaw = link?.teachers?.name_en;
          rememberSubjectName(subjectCnRaw, subjectEnRaw);
          rememberTeacherName(teacherCnRaw, teacherEnRaw);

          const subjectCn = normalizeLookupKey(subjectCnRaw);
          const subjectEn = normalizeLookupKey(subjectEnRaw);
          const teacherCn = normalizeLookupKey(teacherCnRaw);
          const teacherEn = normalizeLookupKey(teacherEnRaw);

          linkMap.set(link.timetable_id, {
            subject_id: link.subject_id ?? null,
            teacher_id: link.teacher_id ?? null,
            subject: (subjectCn || subjectEn) ? { cn: subjectCn, en: subjectEn } : null,
            teacher: (teacherCn || teacherEn) ? { cn: teacherCn, en: teacherEn } : null,
          });
        });
      }

      const { data: tt, error: e2 } = await supabase
        .from("timetable")
        .select("id,class,weekday,period,subject,teacher,group_tag,subject_id,teacher_id")
        .order("class", { ascending: true })
        .order("weekday", { ascending: true })
        .order("period", { ascending: true });
      if (e2) throw e2;

      schedule = (tt || []).map(x => {
        const link = linkMap.get(x.id) || {};
        const subjectId = coalesceDefined(x.subject_id, link.subject_id);
        const teacherId = coalesceDefined(x.teacher_id, link.teacher_id);
        const subjectFromId = subjectId!=null ? subjectsById.get(subjectId) : null;
        const teacherFromId = teacherId!=null ? teachersById.get(teacherId) : null;

        let subjectCn = firstNonEmpty(
          x.subject,
          link.subject?.cn,
          subjectFromId?.cn
        );
        const subjectEn = firstNonEmpty(
          link.subject?.en,
          subjectFromId?.en,
          getSubjectEnglishName(subjectCn)
        );

        if(!subjectCn && subjectEn){
          subjectCn = subjectEn;
        }

        let teacherCn = firstNonEmpty(
          x.teacher,
          link.teacher?.cn,
          teacherFromId?.cn
        );
        const teacherEn = firstNonEmpty(
          link.teacher?.en,
          teacherFromId?.en,
          getTeacherEnglishName(teacherCn)
        );

        if(!teacherCn && teacherEn){
          teacherCn = teacherEn;
        }

        rememberSubjectName(subjectCn, subjectEn);
        rememberTeacherName(teacherCn, teacherEn);

        return {
          id: x.id,
          class: (x.class || "").toUpperCase(),
          weekday: x.weekday,
          period: String(x.period),
          subject: subjectCn || "",
          subject_en: subjectEn || "",
          teacher: teacherCn || "",
          teacher_en: teacherEn || "",
          group: (x.group_tag || "").toLowerCase(),
          subject_id: subjectId ?? null,
          teacher_id: teacherId ?? null,
        };
      });

      buildTeacherClassSelects();
      console.log(`[Supabase] loaded students=${students.length}, timetable=${schedule.length}, subjects=${subjectsById.size}, teachers=${teachersById.size}, links=${linkMap.size}`);
    } catch (err) {
      console.error("Load from Supabase failed:", err);
      alert(t('errorLoadCoreData'));
    }
  }
  document.addEventListener("DOMContentLoaded", loadCoreDataFromSupabase);

  /***** —— 4) 下面粘贴你现有的业务代码（DOM 绑定、工具函数、监看/记录逻辑等）—— *****/
  // —— 这里开始就是你上一段第一个 <script type="module"> 里的全部其余代码 —— 
  // （为省篇幅，此处不重复贴，你原有的：DOM 获取、parsePeriods/weekdayName、renderChips、
  //  updateConflict、buildTexts、记录页/监看页逻辑、Tab 切换、事件绑定……全部保留。）
  // 关键点：不要再出现第二次对 students/schedule 的 let 声明；不要再定义第二个 loadCoreDataFromSupabase。

  // === 复制你的业务代码到这里 ===

/***** —— DOM 绑定 —— *****/
const languageSelect=document.getElementById('languageSelect');
const idQuick=document.getElementById('idQuick');
const btnAddById=document.getElementById('btnAddById');
const idsBulk=document.getElementById('idsBulk');
const btnAddBulk=document.getElementById('btnAddBulk');
const btnClearList=document.getElementById('btnClearList');
const chips=document.getElementById('chips');
const nameCn=document.getElementById('nameCn');
const suggestList=document.getElementById('suggestList');
const ghostNameHint=document.getElementById('ghostNameHint');

const AUTO_ADD_APPLY_COOKIE='leave_auto_add_apply';
const AUTO_ADD_MON_COOKIE='leave_auto_add_monitor';
const MONITOR_TEACHER_COOKIE='leave_monitor_teacher';
const MONITOR_CLASS_COOKIE='leave_monitor_class';

const applyDatePicker=document.getElementById('applyDatePicker');
const autoAddDate=document.getElementById('autoAddDate');
const applyDatePickerStart=document.getElementById('applyDatePickerStart');
const applyDatePickerEnd=document.getElementById('applyDatePickerEnd');
const btnAddRange=document.getElementById('btnAddRange');
const btnAddApplyDate=document.getElementById('btnAddApplyDate');
const applyDateChips=document.getElementById('applyDateChips');
const periodInp=document.getElementById('period');
const activityInp=document.getElementById('activity');
const pwdInp=document.getElementById('pwd');
const conflictDiv=document.getElementById('conflict');
const outBox=document.getElementById('output');
const outCn=document.getElementById('outCn');
const outEn=document.getElementById('outEn');
const btnCopyCn=document.getElementById('btnCopyCn');
const btnCopyEn=document.getElementById('btnCopyEn');

/***** —— 未保存状态 —— *****/
const resetUnsavedState=()=>{ hasUnsavedChanges=false; };
const markUnsaved=()=>{ hasUnsavedChanges=true; };
const updateUnsavedState=()=>{
  if(!pickList.length && !applyDates.length && !(periodInp.value||'').trim() && !(activityInp.value||'').trim()){
    hasUnsavedChanges=false;
  }
};
window.addEventListener('beforeunload',event=>{
  if(!hasUnsavedChanges) return;
  event.preventDefault();
  event.returnValue='';
});

// 记录区
const fltDates=document.getElementById('fltDates');
  const fltClass=document.getElementById('fltClass');
  const fltQuery=document.getElementById('fltQuery');
  const tblBody=document.getElementById('tblBody');
  const btnExport=document.getElementById('btnExport');
  const btnDeleteSelected=document.getElementById('btnDeleteSelected');
  const chkAllRecords=document.getElementById('chkAllRecords');

// 监看区
const monDatePicker=document.getElementById('monDatePicker');
const autoAddMonDate=document.getElementById('autoAddMonDate');
const monDatePickerStart=document.getElementById('monDatePickerStart');
const monDatePickerEnd=document.getElementById('monDatePickerEnd');
const btnAddMonRange=document.getElementById('btnAddMonRange');
const btnAddMonDate=document.getElementById('btnAddMonDate');
const monDateChips=document.getElementById('monDateChips');
const monTeacher=document.getElementById('monTeacher');
const monClass=document.getElementById('monClass');
const monMode=document.getElementById('monMode');
const monResult=document.getElementById('monResult');
const monReasonPanel=document.getElementById('monReasonPanel');
const btnMonRefresh=document.getElementById('btnMonRefresh');
const btnMonExport=document.getElementById('btnMonExport');

let monitorTeacherPreference=null;
let monitorClassPreference=null;

const savedAutoAddApply=getBooleanCookie(AUTO_ADD_APPLY_COOKIE);
if(savedAutoAddApply!==null && autoAddDate){
  autoAddDate.checked=savedAutoAddApply;
}
const savedAutoAddMon=getBooleanCookie(AUTO_ADD_MON_COOKIE);
if(savedAutoAddMon!==null && autoAddMonDate){
  autoAddMonDate.checked=savedAutoAddMon;
}

monitorTeacherPreference=getStringCookie(MONITOR_TEACHER_COOKIE);
monitorClassPreference=getStringCookie(MONITOR_CLASS_COOKIE);

// 时间常量
const PERIODS=[null,
  {label:{zh:'第一节',en:'Period 1'},time:'8:10-8:45'},
  {label:{zh:'第二节',en:'Period 2'},time:'8:45-9:20'},
  {label:{zh:'第三节',en:'Period 3'},time:'9:50-10:25'},
  {label:{zh:'第四节',en:'Period 4'},time:'10:25-11:00'},
  {label:{zh:'第五节',en:'Period 5'},time:'11:10-11:45'},
  {label:{zh:'第六节',en:'Period 6'},time:'11:45-12:20'},
  {label:{zh:'第七节',en:'Period 7'},time:'12:50-13:25'},
  {label:{zh:'第八节',en:'Period 8'},time:'13:25-14:00'},
  {label:{zh:'第九节',en:'Period 9'},time:'14:10-14:45'},
  {label:{zh:'第十节',en:'Period 10'},time:'14:45-15:20'}
];
const PERIOD_NUMS=[1,2,3,4,5,6,7,8,9,10];
const WEEKDAYS_EN=['Monday','Tuesday','Wednesday','Thursday','Friday'];
const WEEKDAY_LABELS={
  zh:{Monday:'星期一',Tuesday:'星期二',Wednesday:'星期三',Thursday:'星期四',Friday:'星期五'},
  en:{Monday:'Monday',Tuesday:'Tuesday',Wednesday:'Wednesday',Thursday:'Thursday',Friday:'Friday'}
};

/***** —— 工具函数 —— *****/
const uniq=arr=>Array.from(new Set(arr));
const trimLower=s=>(s||'').toString().trim().toLowerCase();
const isJuniorClass=cls=>/^J/i.test(cls||'');
const classCodeToCn=cls=>cls||'';
const coalesceDefined=(...values)=>{
  for(const value of values){
    if(value!==undefined && value!==null) return value;
  }
  return null;
};
const firstNonEmpty=(...values)=>{
  for(const value of values){
    if(value==null) continue;
    const text=String(value).trim();
    if(text) return text;
  }
  return '';
};

function escapeHtml(str){
  return (str==null ? '' : String(str))
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function currentLang(){
  try{ return getCurrentLanguage(); }
  catch(err){ return DEFAULT_LANGUAGE; }
}

function getWeekdayLabelLocal(weekday){
  const lang=currentLang();
  return (WEEKDAY_LABELS[lang] && WEEKDAY_LABELS[lang][weekday])
    || (WEEKDAY_LABELS.zh && WEEKDAY_LABELS.zh[weekday])
    || weekday;
}

function getPeriodLabelLocal(period){
  const info=PERIODS[Number(period)];
  if(info && info.label){
    return info.label[currentLang()] || info.label.zh || t('monitorPeriodLabel',{period});
  }
  return t('monitorPeriodLabel',{period});
}

function formatMonitorGroup(group){
  if(!group) return '';
  const upper=String(group).toUpperCase();
  return t('monitorGroupLabel',{group:upper});
}

function wrapGroupDisplay(text){
  if(!text) return '';
  return currentLang()==='zh' ? `（${text}）` : ` (${text})`;
}

function monitorListJoiner(){
  return currentLang()==='zh' ? '，' : ', ';
}

function wrapParenthetical(text){
  if(!text) return '';
  return currentLang()==='zh' ? `（${text}）` : ` (${text})`;
}

function joinWithLocale(items, delimiterOptions){
  const lang=currentLang();
  if(!Array.isArray(items) || !items.length) return '';
  const delimiter=(delimiterOptions && delimiterOptions[lang])
    || (lang==='zh' ? '，' : ', ');
  return items.join(delimiter);
}

function formatConflictSlot(slot){
  if(!slot) return '';
  const periodLabel=t('monitorPeriodLabel',{ period:slot.period });
  const subjectDisplay=getSubjectDisplay(slot);
  const extras=[];
  const teacherDisplay=getTeacherDisplay(slot);
  if(teacherDisplay) extras.push(teacherDisplay);
  if(slot.group){
    extras.push(t('monitorGroupLabel',{ group:String(slot.group).toUpperCase() }));
  }
  const extrasText=extras.length ? wrapParenthetical(joinWithLocale(extras)) : '';
  const subjectText=subjectDisplay ? ` ${subjectDisplay}` : '';
  return `${periodLabel}${subjectText}${extrasText}`;
}

function formatConflictStudentLine(student, lessonsText){
  if(!student || !lessonsText) return '';
  const lang=currentLang();
  const name=lang==='zh'
    ? firstNonEmpty(student.cn, student.en, student.id)
    : firstNonEmpty(student.en, student.cn, student.id);
  const classText=student.class ? (lang==='zh' ? `（${student.class}）` : ` (${student.class})`) : '';
  const separator=lang==='zh' ? '：' : ': ';
  return `${name || ''}${classText}${separator}${lessonsText}`;
}

function getDepartmentDisplay(record){
  if(!record) return '';
  const cn=(record.department_cn||'').toString().trim();
  const en=(record.department_en||'').toString().trim();
  return currentLang()==='zh' ? (cn || en) : (en || cn);
}

function getSubjectDisplay(slot){
  if(!slot) return '';
  if(currentLang()==='en'){
    return firstNonEmpty(slot.subject_en, getSubjectEnglishName(slot.subject), slot.subject);
  }
  return slot.subject || '';
}

function getTeacherDisplay(slot){
  if(!slot) return '';
  if(currentLang()==='en'){
    return firstNonEmpty(slot.teacher_en, getTeacherEnglishName(slot.teacher), slot.teacher);
  }
  return slot.teacher || '';
}

function formatStudentName(record){
  const cn=(record?.name_cn||'').trim();
  const en=(record?.name_en||'').trim();
  const lang=currentLang();
  if(cn && en){
    return lang==='zh' ? `${cn}（${en}）` : `${en} (${cn})`;
  }
  if(lang==='zh'){
    if(cn) return cn;
    if(en) return en;
  }else{
    if(en) return en;
    if(cn) return cn;
  }
  if(record?.id){
    return t('studentIdLabel',{ id: record.id });
  }
  return t('unnamedStudent');
}

function formatStudentDisplays(records){
  if(!Array.isArray(records) || !records.length){
    return { text:'', html:'' };
  }
  const pieces=records.map(rec=>{
    const display=formatStudentName(rec);
    const reasonRaw=(rec?.activity||'').toString().trim();
    const reason=reasonRaw ? reasonRaw : t('reasonFallback');
    const deptRaw=getDepartmentDisplay(rec);
    const attrs=[`data-student="${encodeURIComponent(display)}"`,`data-reason="${encodeURIComponent(reason)}"`];
    if(deptRaw){ attrs.push(`data-department="${encodeURIComponent(deptRaw)}"`); }
    return `<span class="student-item" role="button" tabindex="0" ${attrs.join(' ')}>${escapeHtml(display)}</span>`;
  });
  const joiner=monitorListJoiner();
  return {
    text:records.map(r=>formatStudentName(r)).join(joiner),
    html:pieces.join(joiner)
  };
}

function decodeDatasetValue(value){
  if(!value) return '';
  try {
    return decodeURIComponent(value);
  } catch (err) {
    return value;
  }
}

function hideReasonPanel(){
  if(!monReasonPanel) return;
  monReasonPanel.style.display='none';
  monReasonPanel.innerHTML='';
}

function showStudentReasonPanel(name, reason, department){
  if(!monReasonPanel) return;
  const title=document.createElement('div');
  title.className='reason-title';
  title.textContent=name||t('monitorReasonTitle');

  const frag=document.createDocumentFragment();
  frag.appendChild(title);

  if(department){
    const meta=document.createElement('div');
    meta.className='reason-meta muted';
    meta.textContent=`${t('monitorDepartmentPrefix')}${department}`;
    frag.appendChild(meta);
  }

  const label=document.createElement('div');
  label.className='reason-label muted';
  label.textContent=t('reasonLabel');
  frag.appendChild(label);

  const body=document.createElement('div');
  body.className='reason-body';
  body.textContent=reason || t('reasonFallback');
  frag.appendChild(body);

  const actions=document.createElement('div');
  actions.className='reason-actions';
  const closeBtn=document.createElement('button');
  closeBtn.type='button';
  closeBtn.className='btn ghost';
  closeBtn.textContent=t('btnClose');
  closeBtn.addEventListener('click', hideReasonPanel);
  actions.appendChild(closeBtn);
  frag.appendChild(actions);

  monReasonPanel.innerHTML='';
  monReasonPanel.appendChild(frag);
  monReasonPanel.style.display='block';
  try {
    closeBtn.focus({ preventScroll:true });
  } catch (err) {
    closeBtn.focus();
  }
}

function parseDepartmentFromPassword(input){
  const raw=(input||'').trim();
  if(!raw) return null;
  const normalized=raw.toLowerCase();
  for(const dept of DEPARTMENT_PASSWORDS){
    const list=(dept.passwords||[]).map(p=>p.toLowerCase());
    if(list.includes(normalized)) return { code:dept.code, cn:dept.cn, en:dept.en };
    if(typeof dept.parse==='function'){
      const extra=dept.parse(raw);
      if(extra) return { code:dept.code, cn:dept.cn, en:dept.en, ...extra };
    }
  }
  return null;
}

function ensureDeletionAuthorized(actionKey='deleteRecords'){
  const actionLabel = typeof actionKey==='string' ? t(actionKey) : actionKey;
  const now = Date.now();
  if(deleteAuthCache && (now - deleteAuthCache.ts) < DELETE_AUTH_CACHE_MS){
    return deleteAuthCache.dept;
  }

  if(pwdInp && pwdInp.value){
    const dept = parseDepartmentFromPassword(pwdInp.value);
    if(dept){
      deleteAuthCache = { dept, ts: now };
      return dept;
    }
  }

  while(true){
    const input = prompt(t('promptDeletionPassword',{ action: actionLabel }), '');
    if(input===null) return null;
    const dept = parseDepartmentFromPassword(input);
    if(dept){
      deleteAuthCache = { dept, ts: Date.now() };
      return dept;
    }
    alert(t('errorPasswordIncorrect'));
  }
}

function pickStudentGroupKey(subject){
  const s=(subject||'').toLowerCase();
  if(s.includes('英')||s.startsWith('en')) return 'eng';
  if(s.includes('马')||s.includes('國文')||s.includes('国文')||s.includes('bahasa')||s.includes('bm')) return 'bm';
  if(s.includes('数')||s.includes('math')) return 'math';
  return '';
}

function parsePeriods(text){
  const t=(text||'').trim();
  if(!t) return [];
  if(/\d{1,2}:\d{2}\s*-/.test(t)) return []; // 具体时间段：返回空数组表示“匹配所有课节外的具体时段”
  let m=t.match(/第?\s*(\d+)\s*(?:[—–-]\s*(\d+))?\s*节?/);
  if(m){ const a=+m[1], b=m[2]?+m[2]:a; const res=[]; for(let i=a;i<=b;i++) res.push(String(i)); return res; }
  const nums=t.split(/[^0-9]+/).map(x=>x.trim()).filter(Boolean);
  return nums.length?nums:[];
}
function weekdayName(dateStr){
  const d=new Date(dateStr+'T00:00:00');
  return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d.getDay()];
}
function fmtDateCn(dateStr){
  const d=new Date(dateStr+'T00:00:00');
  const y=d.getFullYear(), m=d.getMonth()+1, da=d.getDate();
  const w=['日','一','二','三','四','五','六'][d.getDay()];
  return `${y}年${m}月${da}日（周${w}）`;
}
function fmtDateEn(dateStr){
  const d=new Date(dateStr+'T00:00:00');
  const y=d.getFullYear();
  const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()];
  const da=d.getDate();
  return `${m} ${da}, ${y}`;
}
function fmtDateYMDLocal(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

/***** —— 名单 chips —— *****/
function renderChips(){
  chips.innerHTML=pickList.map(s=>{
    const display=formatStudentName({ name_cn:s.cn, name_en:s.en, id:s.id });
    return `<span class="chip">${escapeHtml(String(s.id||''))} ${escapeHtml(display)}<button class="btn ghost" data-id="${escapeHtml(String(s.id||''))}">x</button></span>`;
  }).join('');
  updateConflict();
  updateUnsavedState();
}
chips.addEventListener('click',e=>{
  const b=e.target.closest('button[data-id]');
  if(!b) return;
  const id=b.getAttribute('data-id');
  const prevLen=pickList.length;
  pickList=pickList.filter(x=>x.id!==id);
  if(pickList.length!==prevLen) markUnsaved();
  renderChips();
});

function addById(id){
  id=(id||'').trim();
  if(!id){ alert(t('errorEnterStudentId')); return; }
  const s=students.find(x=>String(x.id)===id);
  if(!s){ alert(t('errorStudentNotFound')); return; }
  const sid=String(s.id);
  if(!pickList.some(x=>String(x.id)===sid)){
    pickList.push({id:s.id, cn:s.cn, en:s.en, class:s.class});
    markUnsaved();
  }
  renderChips();
}
btnAddById.onclick=()=>addById(idQuick.value);
idQuick.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addById(idQuick.value); }});

btnAddBulk.onclick=()=>{
  const raw=idsBulk.value||''; const ids=raw.split(/[\s,，;；]+/).map(x=>x.trim()).filter(Boolean);
  if(!ids.length){ alert(t('errorEnterIdsFirst')); return; }
  let added=0, miss=[]; ids.forEach(id=>{ const s=students.find(x=>String(x.id)===id); if(!s){ miss.push(id); return; } const sid=String(s.id); if(!pickList.some(x=>String(x.id)===sid)){ pickList.push({id:s.id,cn:s.cn,en:s.en,class:s.class}); added++; } });
  if(added>0) markUnsaved();
  renderChips();
  if(miss.length){
    alert(t('bulkAddSummaryWithMissing',{ count:added, missing:miss.join(' ') }));
  }else{
    alert(t('bulkAddSummary',{ count:added }));
  }
};
btnClearList.onclick=()=>{ pickList=[]; renderChips(); resetUnsavedState(); };

const handleApplyFieldInput=()=>{ markUnsaved(); updateUnsavedState(); };
periodInp.addEventListener('input',handleApplyFieldInput);
activityInp.addEventListener('input',handleApplyFieldInput);

/***** —— 模糊搜索 —— *****/
let candidates=[]; let highlightIndex=-1;

function updateGhostNameHint(){
  if(!ghostNameHint) return;
  const item=candidates[highlightIndex];
  ghostNameHint.textContent=item
    ? t('ghostPreselect',{ id:item.id||'', cn:item.cn||'', en:item.en||'', class:item.class||'' })
    : '';
}

function ensureActiveItemVisible(){
  if(!suggestList) return;
  const active=suggestList.querySelector('.suggest-item.active');
  if(!active) return;
  const top=active.offsetTop;
  const bottom=top+active.offsetHeight;
  const viewTop=suggestList.scrollTop;
  const viewBottom=viewTop+suggestList.clientHeight;
  if(top<viewTop){
    suggestList.scrollTop=top;
  }else if(bottom>viewBottom){
    suggestList.scrollTop=bottom-suggestList.clientHeight;
  }
}

function applyHighlightToSuggestItems(){
  if(!suggestList) return;
  const items=suggestList.querySelectorAll('.suggest-item');
  items.forEach((el,idx)=>{
    if(idx===highlightIndex){
      el.classList.add('active');
    }else{
      el.classList.remove('active');
    }
  });
  updateGhostNameHint();
  ensureActiveItemVisible();
}

function renderSuggest(list){
  candidates=list;
  if(!list.length){
    suggestList.style.display='none';
    highlightIndex=-1;
    updateGhostNameHint();
    suggestList.scrollTop=0;
    return;
  }
  if(highlightIndex<0||highlightIndex>=list.length) highlightIndex=0;
  suggestList.innerHTML=list.map((s,i)=>`<div class="suggest-item" data-idx="${i}" data-id="${s.id}">${s.id} / ${s.cn} / ${s.en} / ${s.class} ${s.pinyin?(' / '+s.pinyin):''}</div>`).join('');
  suggestList.style.display='block';
  applyHighlightToSuggestItems();
}

function moveHighlight(delta){
  if(!candidates.length) return;
  if(highlightIndex<0){
    highlightIndex=delta>=0?0:candidates.length-1;
  }else{
    highlightIndex=(highlightIndex+delta+candidates.length)%candidates.length;
  }
  applyHighlightToSuggestItems();
}

nameCn.addEventListener('input',()=>{
  const q=trimLower(nameCn.value); if(!q){ renderSuggest([]); return; }
  const list=students.filter(s=>{ const hay=[s.cn,s.en,s.pinyin].map(trimLower).join(' '); return hay.includes(q) || q.split(/\s+/).every(part=>hay.includes(part)); }).slice(0,30);
  renderSuggest(list);
});
nameCn.addEventListener('keydown',e=>{
  if(e.key==='Tab'){ e.preventDefault(); moveHighlight(e.shiftKey?-1:1); return; }
  if(e.key==='ArrowDown'){ e.preventDefault(); moveHighlight(1); return; }
  if(e.key==='ArrowUp'){ e.preventDefault(); moveHighlight(-1); return; }
  if(e.key==='Enter'){
    e.preventDefault(); const it=candidates[highlightIndex];
    if(it){ addById(it.id); nameCn.value=''; suggestList.style.display='none'; candidates=[]; highlightIndex=-1; nameCn.focus(); }
    else if(idQuick.value){ addById(idQuick.value); nameCn.focus(); }
    return;
  }
  if(e.key==='Escape'){ renderSuggest([]); return; }
});
suggestList.addEventListener('click',e=>{ const div=e.target.closest('.suggest-item'); if(!div) return; const id=div.getAttribute('data-id'); const s=students.find(x=>x.id===id); if(!s) return; addById(s.id); nameCn.value=''; suggestList.style.display='none'; candidates=[]; highlightIndex=-1; nameCn.focus(); });
document.addEventListener('click',e=>{ if(!suggestList.contains(e.target) && e.target!==nameCn){ suggestList.style.display='none'; }});

/***** —— 多日期 chips —— *****/
const applyDatesUI = {
  render(){
    applyDateChips.innerHTML=applyDates.map(d=>`<span class="chip">${d}<button class="btn ghost" data-d="${d}">x</button></span>`).join('');
    updateConflict();
    updateUnsavedState();
  }
};
btnAddApplyDate.onclick=()=>{
  const d=applyDatePicker.value;
  if(!d) return;
  if(!applyDates.includes(d)){
    applyDates.push(d);
    applyDates.sort();
    markUnsaved();
  }
  applyDatesUI.render();
};

if(autoAddDate){
  autoAddDate.addEventListener('change',()=>{
    setBooleanPreferenceCookie(AUTO_ADD_APPLY_COOKIE, !!autoAddDate.checked);
  });
}

applyDatePicker.addEventListener('change',()=>{
  if(autoAddDate && autoAddDate.checked){
    const d=applyDatePicker.value;
    if(!d) return;
    if(!applyDates.includes(d)){
      applyDates.push(d);
      applyDates.sort();
      markUnsaved();
    }
    applyDatesUI.render();
  }
});
btnAddRange.onclick=()=>{
  const a=applyDatePickerStart.value, b=applyDatePickerEnd.value; if(!a||!b){ alert(t('errorSelectRange')); return; }
  const start=new Date(a+'T00:00:00'), end=new Date(b+'T00:00:00');
  if(start>end){ alert(t('errorRangeOrder')); return; }
  const cur=new Date(start);
  let added=0;
  while(cur<=end){ const d=fmtDateYMDLocal(cur); if(!applyDates.includes(d)){ applyDates.push(d); added++; } cur.setDate(cur.getDate()+1); }
  applyDates.sort();
  if(added>0) markUnsaved();
  applyDatesUI.render();
};
applyDateChips.addEventListener('click',e=>{
  const b=e.target.closest('button[data-d]');
  if(!b) return;
  const d=b.getAttribute('data-d');
  const prevLen=applyDates.length;
  applyDates=applyDates.filter(x=>x!==d);
  if(applyDates.length!==prevLen) markUnsaved();
  applyDatesUI.render();
});

/***** —— 冲堂提示（按第一个日期） —— *****/
function updateConflict(){
  conflictDiv.textContent='';
  if(!schedule.length || !applyDates.length || !periodInp.value || !pickList.length) return;
  const wd=weekdayName(applyDates[0]);
  if(wd==='Sunday'||wd==='Saturday'){ conflictDiv.textContent=t('conflictWeekend'); return; }
  const ps=parsePeriods(periodInp.value);
  if(!ps.length){ conflictDiv.textContent=t('conflictNoPeriods'); return; }
  const lines=[];
  pickList.forEach(sel=>{
    const stu=students.find(x=>x.id===sel.id); if(!stu) return;
    const hits=schedule.filter(x=> x.class===sel.class && x.weekday===wd && ps.includes(String(x.period)));
    const filtered=hits.filter(h=>{ const gkey=pickStudentGroupKey(h.subject); if(isJuniorClass(sel.class) && gkey && h.group){ return (stu[gkey]||'').toLowerCase()===h.group.toLowerCase(); } return true; });
    if(filtered.length){
      const lessons=joinWithLocale(filtered.map(formatConflictSlot),{ zh:'，', en:'; ' });
      const line=formatConflictStudentLine(sel, lessons);
      if(line) lines.push(line);
    }
  });
  if(!lines.length){
    conflictDiv.textContent=t('conflictNoLessons');
    return;
  }
  const prefix=escapeHtml(t('conflictSummaryTitle'));
  const separator=currentLang()==='zh' ? '：' : ': ';
  const joiner=currentLang()==='zh' ? '；' : '; ';
  const body=lines.map(line=>escapeHtml(line)).join(joiner);
  conflictDiv.innerHTML=`<span class="danger">${prefix}</span>${separator}${body}`;
}
periodInp.oninput=updateConflict;

/***** —— 文本生成（并写入记录） —— *****/
function buildTexts(){
  if(!pickList.length){ alert(t('errorNeedList')); return null; }
  if(!applyDates.length){ alert(t('errorNeedDate')); return null; }
  if(!periodInp.value){ alert(t('errorNeedPeriod')); return null; }
  if(!activityInp.value){ alert(t('errorNeedActivity')); return null; }
  const deptInfo=parseDepartmentFromPassword(pwdInp.value);
  if(!deptInfo){ alert(t('errorPasswordIncorrect')); return null; }

  const periodText=periodInp.value.trim();
  const blocksCn=[], blocksEn=[];
  applyDates.forEach(d=>{
    const dateCn=fmtDateCn(d), dateEn=fmtDateEn(d);
    const listCn=pickList.map((s,i)=>`${i+1}. ${s.id} ${classCodeToCn(s.class)} ${s.cn}（${s.en}）`).join('\n');
    const listEn=pickList.map((s,i)=>`${i+1}. ${s.en} (${s.cn}), Class ${classCodeToCn(s.class)}, ID ${s.id}`).join('\n');

    // per-date 冲堂
    const wd=weekdayName(d), ps=parsePeriods(periodText);
    let missCn='', missEn='';
    if(schedule.length && ps.length){
      const linesCn=[];
      const linesEn=[];
      pickList.forEach(sel=>{
        const stu=students.find(x=>x.id===sel.id); if(!stu) return;
        const hits=schedule.filter(x=> x.class===sel.class && x.weekday===wd && ps.includes(String(x.period)));
        const filtered=hits.filter(h=>{ const gkey=pickStudentGroupKey(h.subject); if(isJuniorClass(sel.class) && gkey && h.group){ return (stu[gkey]||'').toLowerCase()===h.group.toLowerCase(); } return true; });
        if(filtered.length){
          const msgCn=filtered.map(h=>`第${h.period}节 ${h.subject}（${h.teacher}${h.group?('，'+h.group.toUpperCase()+'组'):''}）`).join('，');
          linesCn.push(`${sel.cn}（${sel.class}）：${msgCn}`);

          const msgEnParts=filtered.map(h=>{
            const subjectLabel=firstNonEmpty(h.subject_en, getSubjectEnglishName(h.subject), h.subject);
            const teacherLabel=firstNonEmpty(h.teacher_en, getTeacherEnglishName(h.teacher), h.teacher);
            const extras=[];
            if(teacherLabel) extras.push(teacherLabel);
            if(h.group) extras.push(`Group ${String(h.group).toUpperCase()}`);
            let base=`Period ${h.period}`;
            if(subjectLabel){
              base+=` ${subjectLabel}`;
            }
            if(extras.length){
              base+=` (${extras.join(', ')})`;
            }
            return base;
          });
          const studentLabelEn=`${firstNonEmpty(sel.en, sel.cn, sel.id)} (${sel.class})`;
          linesEn.push(`${studentLabelEn}: ${msgEnParts.join(', ')}`);
        }
      });
      missCn=linesCn.join('；');
      missEn=linesEn.join(' ; ');
    }

    const cn=`校长、老师们好：
本校学生拟于【${dateCn}】在【${periodText}】上课外出，前往参加【${activityInp.value.trim()}】。

名单：
${listCn}

${missCn?`请假期间冲堂课程：${missCn}。\n`:''}如有不便，敬请见谅。

${deptInfo.cn}
日期：${dateCn}`;

    let periodEn=periodText; if(/第.*节/.test(periodEn)){ periodEn='period '+periodEn.replace(/[第节]/g,'').replace('-', '–'); }
    const en=`Dear Principal and Teachers,

The following students will be officially released from class on ${dateEn}, during ${periodEn}, to participate in "${activityInp.value.trim()}". 

List:
${listEn}

${missEn?`Classes missed: ${missEn}.\n`:''}We apologize for any inconvenience caused.

${deptInfo.en}
Date: ${dateEn}`;

    blocksCn.push(cn); blocksEn.push(en);
  });

  return {
    cn: blocksCn.join('\n\n'+ '——'.repeat(20) +'\n\n'),
    en: blocksEn.join('\n\n'+ '—'.repeat(40) +'\n\n'),
    dept: deptInfo
  };
}

document.getElementById('btnGenText').onclick=()=>{
  const t=buildTexts(); if(!t) return;
  outBox.style.display='block'; outCn.value=t.cn; outEn.value=t.en;
};

async function saveCurrentApplication(options={}){
  const { force=false, silent=false } = options;
  const t=buildTexts();
  if(!t) return null;

  outBox.style.display='block';
  outCn.value=t.cn;
  outEn.value=t.en;

  if(!force && !hasUnsavedChanges){
    return { text:t, saved:false };
  }

  try{
    const base={
      period:(periodInp.value||'').trim(),
      activity:(activityInp.value||'').trim(),
      department_cn:t.dept?.cn||'',
      department_en:t.dept?.en||'',
      department_code:t.dept?.code||''
    };
    const nowTs=Date.now();
    const rows=[];
    applyDates.forEach(d=>{
      pickList.forEach(s=>{
        rows.push({
          date:d,
          period:base.period,
          student_id:s.id,
          class:s.class,
          name_cn:s.cn,
          name_en:s.en,
          activity:base.activity,
          department_cn:base.department_cn,
          department_en:base.department_en,
          department_code:base.department_code,
          client_ts:nowTs,
        });
      });
    });

    if(!rows.length){
      if(!silent) alert(t('saveNothing'));
      return { text:t, saved:false };
    }

    const rowsForInsert=rows.map(r=>({ ...r }));
    let { error } = await supabase.from('applications_flat').insert(rowsForInsert);
    if(error){
      const msg=(error.message||'').toLowerCase();
      if(msg.includes('column') && msg.includes('department')){
        const stripped=rowsForInsert.map(({ department_cn, department_en, department_code, ...rest })=>rest);
        const retry=await supabase.from('applications_flat').insert(stripped);
        if(retry.error) throw retry.error;
      }else{
        throw error;
      }
    }

    const allLocal=JSON.parse(localStorage.getItem('leave_records')||'[]');
    rows.forEach(r=>allLocal.push({ ...r, ts:r.client_ts }));
    localStorage.setItem('leave_records', JSON.stringify(allLocal));

    resetUnsavedState();
    if(!silent) alert(t('saveSuccess',{ count:rows.length }));
    return { text:t, saved:true };
  }catch(e){
    console.error('Save to Supabase failed:', e);
    if(!silent) alert(t('saveFailed'));
    return null;
  }
}

document.getElementById('btnSave').onclick=async()=>{
  await saveCurrentApplication({ force:true });
};

btnCopyCn.onclick=async()=>{
  const result=await saveCurrentApplication({ silent:true });
  if(!result) return;
  try{
    await navigator.clipboard.writeText(result.text.cn||'');
    alert(t('copyCnSuccess'));
  }catch(e){
    alert(t('copyFailed',{ message:e.message||'' }));
  }
};
btnCopyEn.onclick=async()=>{
  const result=await saveCurrentApplication({ silent:true });
  if(!result) return;
  try{
    await navigator.clipboard.writeText(result.text.en||'');
    alert(t('copyEnSuccess'));
  }catch(e){
    alert(t('copyEnFailed',{ message:e.message||'' }));
  }
};

/***** —— 记录页（云端读写） —— */
function parseDatesMulti(text){ return (text||'').split(/[^0-9-]+/).map(s=>s.trim()).filter(Boolean); }

async function fetchFilteredRecordsFromCloud(){
  const columnsFull='date, period, student_id, class, name_cn, name_en, activity, department_cn, department_en, department_code, client_ts, inserted_at';
  const columnsFallback='date, period, student_id, class, name_cn, name_en, activity, client_ts, inserted_at';
  const dates = parseDatesMulti(fltDates.value);
  const cls = (fltClass.value||'').trim();
  const kw  = (fltQuery.value||'').trim().toLowerCase();
  const buildQuery=(cols)=>{
    let query = supabase
      .from('applications_flat')
      .select(cols)
      .order('date', { ascending: true })
      .order('inserted_at', { ascending: true });
    if (dates.length) query = query.in('date', dates);
    if (cls) query = query.eq('class', cls.toUpperCase());
    return query;
  };
  let q = buildQuery(columnsFull);

  let { data, error } = await q;
  if (error){
    const msg=(error.message||'').toLowerCase();
    if(msg.includes('column') && msg.includes('department')){
      q = buildQuery(columnsFallback);
      ({ data, error } = await q);
    }
  }
  if (error){ console.error(error); alert(t('errorFetchRecords')); return []; }

  const list = (data||[]).filter(r=>{
    if (!kw) return true;
    return (r.student_id||'').toLowerCase().includes(kw)
      || (r.name_cn||'').toLowerCase().includes(kw)
      || (r.name_en||'').toLowerCase().includes(kw);
  });

  return list;
}

async function refreshTable(){
  const list = await fetchFilteredRecordsFromCloud();
  tblBody.innerHTML = list.map((r,i)=>{
    const tsAttr = r.client_ts!=null ? String(r.client_ts) : '';
    const selectable = r.date && r.student_id && tsAttr;
    const checkboxAttrs = selectable ? `data-date="${r.date}" data-sid="${r.student_id}" data-ts="${tsAttr}"` : 'disabled';
    return `
    <tr>
      <td><input type="checkbox" class="record-select" ${checkboxAttrs}></td>
      <td class="nowrap">${r.date||''}</td>
      <td class="nowrap">${r.period||''}</td>
      <td>${r.student_id||''}</td>
      <td>${r.class||''}</td>
      <td>${r.name_cn||''}</td>
      <td>${r.name_en||''}</td>
      <td>${r.activity||''}</td>
      <td>${getDepartmentDisplay(r)}</td>
      <td><button class="btn ghost" data-idx="${i}" data-date="${r.date}" data-sid="${r.student_id}" data-ts="${r.client_ts||''}">${escapeHtml(t('deleteRecords'))}</button></td>
    </tr>
  `;
  }).join('');
  if(chkAllRecords){
    chkAllRecords.checked=false;
    chkAllRecords.indeterminate=false;
    updateMasterCheckboxState();
  }
  refreshTable._cache = list;
}
[fltDates,fltClass,fltQuery].forEach(el=> el.addEventListener('input',refreshTable));

function updateMasterCheckboxState(){
  if(!chkAllRecords) return;
  const boxes=tblBody.querySelectorAll('input.record-select:not([disabled])');
  if(!boxes.length){
    chkAllRecords.checked=false;
    chkAllRecords.indeterminate=false;
    return;
  }
  const checkedCount=[...boxes].filter(box=>box.checked).length;
  chkAllRecords.checked=checkedCount===boxes.length;
  chkAllRecords.indeterminate=checkedCount>0 && checkedCount<boxes.length;
}

if(chkAllRecords){
  chkAllRecords.addEventListener('change',()=>{
    const boxes=tblBody.querySelectorAll('input.record-select:not([disabled])');
    boxes.forEach(box=>{ box.checked=chkAllRecords.checked; });
    updateMasterCheckboxState();
  });
}

tblBody.addEventListener('change',e=>{
  const cb=e.target.closest('input.record-select');
  if(!cb) return;
  updateMasterCheckboxState();
});

tblBody.addEventListener('click', async e=>{
  const btn = e.target.closest('button[data-idx]');
  if(!btn) return;
  const date = btn.getAttribute('data-date');
  const sid  = btn.getAttribute('data-sid');
  const ts   = btn.getAttribute('data-ts');
  if(!date || !sid || !ts){ alert(t('errorMissingDeleteKeys')); return; }
  if(!confirm(t('confirmDeleteSingle',{ date, studentId:sid }))) return;
  if(!ensureDeletionAuthorized('deleteRecords')) return;

  const { error } = await supabase
    .from('applications_flat')
    .delete()
    .match({ date, student_id: sid, client_ts: Number(ts) });

  if(error){ console.error(error); alert(t('errorDeleteFailed')); return; }
  refreshTable();
});

btnExport.onclick=()=>{
  const list = refreshTable._cache || [];
  if(!list.length){ alert(t('exportEmpty')); return; }
  const header=[
    t('thDate'),
    t('thPeriod'),
    t('thStudentId'),
    t('thClass'),
    t('thNameCn'),
    t('thNameEn'),
    t('thActivity'),
    t('thDepartment')
  ];
  const lines=[header.join(',')].concat(
    list.map(r=>[
      r.date,
      r.period,
      r.student_id,
      r.class,
      r.name_cn,
      r.name_en,
      r.activity,
      getDepartmentDisplay(r)
    ].map(s=>`"${(s||'').toString().replace(/"/g,'""')}"`).join(','))
  );
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=t('exportRecordsFilename'); a.click();
};

btnDeleteSelected.onclick=async ()=>{
  const selected=[...tblBody.querySelectorAll('input.record-select:checked')];
  if(!selected.length){ alert(t('alertSelectRecords')); return; }
  if(!confirm(t('confirmDeleteSelected',{ count:selected.length }))) return;
  if(!ensureDeletionAuthorized('deleteRecords')) return;

  for(const cb of selected){
    const date=cb.getAttribute('data-date');
    const sid=cb.getAttribute('data-sid');
    const ts=cb.getAttribute('data-ts');
    if(!date || !sid || !ts){
      console.warn('[records] Skipping entry without identifiers', { date, sid, ts });
      alert(t('errorMissingDeleteKeys'));
      continue;
    }
    const { error } = await supabase
      .from('applications_flat')
      .delete()
      .match({ date, student_id: sid, client_ts: Number(ts) });
    if(error){
      console.error('[records] Delete failed:', error);
      alert(t('errorDeletePartial'));
      refreshTable();
      return;
    }
  }

  alert(t('successDelete'));
  refreshTable();
};

/***** —— 监看（云端） —— */
let monCloudCache = [];  // {date, period, student_id, class, name_cn, name_en, activity, department_*, client_ts}
async function ensureMonitorDefaults(){
  const hasDates = monDates.length>0;
  if(monitorDefaultInitialized && hasDates){
    monitorDefaultActive = !monitorUserModified && monMode.value==='timetable';
    return;
  }
  if(hasDates){
    monitorDefaultInitialized = true;
    monitorDefaultActive = !monitorUserModified && monMode.value==='timetable';
    return;
  }
  // 若列表为空则重新尝试加载默认值，即使用户曾经修改过
  if(monitorUserModified){
    monitorDefaultActive = false;
  }

  try {
    const { data, error } = await supabase
      .from('applications_flat')
      .select('date', { distinct: true })
      .order('date', { ascending: true });
    if (error) throw error;
    const list = Array.from(new Set((data||[]).map(item => item.date).filter(Boolean))).sort();
    const todayStr = new Date().toISOString().slice(0,10);
    const upcoming = list.filter(d => d >= todayStr);
    const effective = upcoming.length ? upcoming : [];
    if (effective.length) {
      monDates = effective;
      monDatesUI.render();
      monMode.value = 'timetable';
      monitorDefaultActive = true;
      monitorDefaultInitialized = true;
      monitorUserModified = false;
    } else {
      monDates = [];
      monDatesUI.render();
      monitorDefaultActive = false;
      monitorDefaultInitialized = true;
    }
  } catch (err) {
    console.error('[monitor] Failed to load default dates:', err);
    monitorDefaultActive = false;
    monitorDefaultInitialized = false;
  }
}

async function loadMonitorRecordsFromCloud(){
  if(!monDates.length){ monCloudCache = []; return; }
  const columnsFull='date, period, student_id, class, name_cn, name_en, activity, department_cn, department_en, department_code, client_ts';
  const columnsFallback='date, period, student_id, class, name_cn, name_en, activity, client_ts';
  let query = supabase
    .from('applications_flat')
    .select(columnsFull)
    .in('date', monDates);
  let { data, error } = await query;
  if(error){
    const msg=(error.message||'').toLowerCase();
    if(msg.includes('column') && msg.includes('department')){
      query = supabase
        .from('applications_flat')
        .select(columnsFallback)
        .in('date', monDates);
      ({ data, error } = await query);
    }
  }
  if(error){ console.error(error); alert(t('errorMonitorFetch')); monCloudCache = []; return; }
  monCloudCache = data || [];
}
function getAllRecords(){ // 监看内部依赖的统一取数
  return monCloudCache.map(r=>({
    date: r.date,
    period: r.period,
    id: r.student_id,
    class: r.class,
    name_cn: r.name_cn,
    name_en: r.name_en,
    activity: r.activity,
    department_cn: r.department_cn || '',
    department_en: r.department_en || '',
    department_code: r.department_code || '',
    ts: r.client_ts || 0
  }));
}

function recordMatchesSlot(rec, slot){
  if(rec.class!==slot.class) return false;
  const gkey=pickStudentGroupKey(slot.subject);
  if(isJuniorClass(slot.class) && gkey && slot.group){
    const stu=students.find(x=>x.id===rec.id && x.class===rec.class);
    if(!(stu && (stu[gkey]||'').toLowerCase()===slot.group.toLowerCase())) return false;
  }
  const ps=parsePeriods(rec.period); if(!ps.length) return true; // 具体时段
  return ps.includes(String(slot.period));
}

function buildMonitorRowsForDate(d){
  const wd=weekdayName(d);
  const recs=getAllRecords().filter(r=>r.date===d);

  if(!schedule.length){
    return recs.map(r=>{
      const displays=formatStudentDisplays([r]);
      return {
        date:d,
        period:r.period||'',
        class:r.class,
        group:'',
        subject:'',
        teacher:'',
        students:displays.text,
        studentsHtml:displays.html
      };
    });
  }

  let slots=schedule.filter(x=>x.weekday===wd);
  if(monTeacher.value) slots=slots.filter(x=>x.teacher===monTeacher.value);
  if(monClass.value)   slots=slots.filter(x=>x.class===monClass.value);
  slots.sort((a,b)=> a.class.localeCompare(b.class) || (+a.period - +b.period));

  const rows=[];
  slots.forEach(s=>{
    const matched=recs.filter(r=> recordMatchesSlot(r,s));
    const displays=formatStudentDisplays(matched);
    const periodLabel=getPeriodLabelLocal(s.period);
    const groupLabel=formatMonitorGroup(s.group);
    const subjectDisplay=getSubjectDisplay(s);
    const teacherDisplay=getTeacherDisplay(s);
    rows.push({
      date:d,
      period:periodLabel,
      class:s.class,
      group:groupLabel,
      subject:subjectDisplay,
      teacher:teacherDisplay,
      students:displays.text,
      studentsHtml:displays.html
    });
  });

  const orphan=recs.filter(r=>{
    const ps=parsePeriods(r.period);
    if(!ps.length) return true;
    return !slots.some(s => s.class===r.class && s.weekday===wd && ps.includes(String(s.period)));
  });

  orphan.forEach(r=>{
    const displays=formatStudentDisplays([r]);
    rows.push({
      date:d,
      period:r.period || t('monitorSpecificSlot'),
      class:r.class,
      group:'',
      subject:t('monitorNoSchedule'),
      teacher:'',
      students:displays.text,
      studentsHtml:displays.html
    });
  });

  return rows;
}

async function buildMonitorView(){
  hideReasonPanel();
  monResult.innerHTML='';
  if(!monitorDefaultInitialized || !monDates.length){
    await ensureMonitorDefaults();
  }
  monitorDefaultActive = monitorDefaultActive && monMode.value==='timetable';
  if(!monDates.length){
    monResult.innerHTML=`<div class="muted">${escapeHtml(t('errorMonitorNeedDate'))}</div>`;
    return;
  }

  await loadMonitorRecordsFromCloud();

  if(monMode.value==='timetable'){ buildMonitorTimetable(); return; }

  let allRows=[]; monDates.forEach(d=>{ allRows=allRows.concat(buildMonitorRowsForDate(d)); });

  if(monMode.value==='cards'){
    const teacherLabel=escapeHtml(t('monitorCardTeacherLabel'));
    const studentsLabel=escapeHtml(t('monitorCardStudentsLabel'));
    const emptyStudentsHtml=`<span class="muted">${escapeHtml(t('monitorCardNoStudents'))}</span>`;
    const html=allRows.map(r=>{
      const dateText=escapeHtml(r.date||'');
      const periodText=escapeHtml(r.period||'');
      const classText=escapeHtml(r.class||'');
      const groupWrap=r.group ? wrapGroupDisplay(r.group) : '';
      const groupText=groupWrap ? escapeHtml(groupWrap) : '';
      const subjectText=escapeHtml(r.subject||'');
      const subjectDisplay=subjectText || '—';
      const teacherText=r.teacher ? escapeHtml(r.teacher) : '—';
      const studentsHtml=r.studentsHtml || emptyStudentsHtml;
      return `<div class="list" style="margin-bottom:8px;">
        <div><strong>${dateText}</strong>　${periodText}　${classText}${groupText}　${subjectDisplay}　<span class="muted">${teacherLabel}${teacherText}</span></div>
        <div>${studentsLabel}${studentsHtml}</div>
      </div>`;
    }).join('');
    monResult.innerHTML=html || `<div class="muted">${escapeHtml(t('monitorNoResults'))}</div>`;
    return;
  }

  const header=[
    t('thDate'),
    t('monitorTablePeriodColumn'),
    t('thClass'),
    t('monitorTableGroupColumn'),
    t('monitorTableSubjectColumn'),
    t('monitorTableTeacherColumn'),
    t('monitorTableStudentsColumn')
  ];
  const noStudentsCell=`<span class="muted">${escapeHtml(t('monitorCardNoStudents'))}</span>`;
  const rowsHtml=allRows.map(r=>{
    const dateCell=escapeHtml(r.date||'');
    const periodCell=escapeHtml(r.period||'');
    const classCell=escapeHtml(r.class||'');
    const groupCell=r.group ? escapeHtml(r.group) : '—';
    const subjectCell=escapeHtml(r.subject||'');
    const teacherCell=r.teacher ? escapeHtml(r.teacher) : '—';
    const studentsCell=r.studentsHtml || noStudentsCell;
    return `<tr>
      <td class="nowrap">${dateCell}</td>
      <td class="nowrap">${periodCell||'—'}</td>
      <td>${classCell||'—'}</td>
      <td>${groupCell}</td>
      <td>${subjectCell||'—'}</td>
      <td>${teacherCell}</td>
      <td>${studentsCell}</td>
    </tr>`;
  }).join('');
  const headerHtml=header.map(h=>`<th>${escapeHtml(h)}</th>`).join('');
  const emptyRow=`<tr><td colspan="7" class="muted">${escapeHtml(t('monitorNoResultsShort'))}</td></tr>`;
  monResult.innerHTML = `<div class="scroll-x"><table><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml||emptyRow}</tbody></table></div>`;
}

function buildMonitorTimetable(){
  const dates=monDates.slice().sort();
  if(!dates.length){
    monResult.innerHTML=`<div class="muted">${escapeHtml(t('errorMonitorNeedDate'))}</div>`;
    return;
  }

  const allRecords=getAllRecords();
  const sections=dates.map(d=>renderMonitorTimetableForDate(d, allRecords)).filter(Boolean);
  monResult.innerHTML=sections.join('') || `<div class="muted">${escapeHtml(t('monitorNoResults'))}</div>`;
}

function renderMonitorTimetableForDate(date, allRecords){
  const wd=weekdayName(date);
  const weekdayLabel=getWeekdayLabelLocal(wd);
  const dayRecords=allRecords.filter(r=>r.date===date);
  const dateText=escapeHtml(date||'');
  const weekdayText=escapeHtml(weekdayLabel);
  const dateDisplay=`${dateText}${wrapParenthetical(weekdayText)}`;
  const colonSeparator=currentLang()==='zh' ? '：' : ': ';
  const noStudentsHtml=`<span class="muted">${escapeHtml(t('monitorCardNoStudents'))}</span>`;

  if(!schedule.length){
    if(!dayRecords.length){
      const msg=monitorDefaultActive ? t('monitorNoMissing') : t('monitorNoResults');
      return `<div class="ttable scroll-x" style="margin-bottom:12px;"><div class="muted" style="padding:8px;">${dateDisplay}${colonSeparator}${escapeHtml(msg)}</div></div>`;
    }
    const items=dayRecords.map(r=>{
      const displays=formatStudentDisplays([r]);
      const classText=escapeHtml(r.class||'');
      const periodText=escapeHtml(r.period||t('monitorSpecificSlot'));
      const studentsHtml=displays.html || noStudentsHtml;
      return `<div class="slot"><div class="slot-title">${classText} · ${periodText}</div><div class="students">${studentsHtml}</div></div>`;
    }).join('');
    return `<div class="ttable scroll-x" style="margin-bottom:12px;"><div class="muted" style="padding:6px 8px 0;">${dateDisplay}</div><div class="cell">${items}</div></div>`;
  }

  let slots=schedule.filter(x=>x.weekday===wd);
  if(monTeacher.value) slots=slots.filter(x=>x.teacher===monTeacher.value);
  if(monClass.value) slots=slots.filter(x=>x.class===monClass.value);
  slots.sort((a,b)=> a.class.localeCompare(b.class) || (+a.period - +b.period));

  const periodCells=PERIOD_NUMS.map(period=>{
    const related=slots.filter(s=>String(s.period)===String(period));
    if(!related.length) return { period, html:'', hasContent:false };
    const pieces=[];
    related.forEach(s=>{
      const matched=dayRecords.filter(r=> recordMatchesSlot(r,s));
      if(!matched.length && monitorDefaultActive) return;
      const displays=formatStudentDisplays(matched);
      const listHtml=displays.html || noStudentsHtml;
      const classText=escapeHtml(s.class||'');
      const groupDisplay=formatMonitorGroup(s.group);
      const groupWrap=groupDisplay ? escapeHtml(wrapGroupDisplay(groupDisplay)) : '';
      const subjectDisplayText=getSubjectDisplay(s);
      const subjectText=escapeHtml(subjectDisplayText||'');
      const subjectDisplay=subjectText || '—';
      const teacherDisplayText=getTeacherDisplay(s);
      const teacherText=escapeHtml((teacherDisplayText||'—'));
      const teacherWrap=wrapParenthetical(teacherText);
      pieces.push(`<div class="slot"><div class="slot-title">${classText}${groupWrap} · ${subjectDisplay}${teacherWrap}</div><div class="students">${listHtml}</div></div>`);
    });
    const hasContent=pieces.length>0;
    if(!hasContent && !monitorDefaultActive){
      pieces.push('<span class="muted">—</span>');
    }
    return { period, html:pieces.join(''), hasContent };
  });

  let activeCells=periodCells;
  if(monitorDefaultActive){
    const filtered=periodCells.filter(cell=>cell.hasContent);
    if(filtered.length) activeCells=filtered;
  }

  const orphanRecords=dayRecords.filter(r=>{
    if(monClass.value && r.class!==monClass.value) return false;
    const ps=parsePeriods(r.period);
    if(!ps.length) return true;
    return !slots.some(s=> recordMatchesSlot(r,s));
  });
  const orphanPieces=orphanRecords.map(r=>{
    const displays=formatStudentDisplays([r]);
    const classText=escapeHtml(r.class||'');
    const periodText=escapeHtml(r.period||t('monitorSpecificSlot'));
    const studentsHtml=displays.html || noStudentsHtml;
    return `<div class="slot"><div class="slot-title">${classText} · ${periodText}</div><div class="students">${studentsHtml}</div></div>`;
  });

  const hasGridContent=activeCells.some(cell=>cell.hasContent);
  const hasOrphan=orphanPieces.length>0;

  if(!hasGridContent && !hasOrphan){
    const msg=monitorDefaultActive ? t('monitorNoMissing') : t('monitorNoResults');
    return `<div class="ttable scroll-x" style="margin-bottom:12px;"><div class="muted" style="padding:8px;">${dateDisplay}${colonSeparator}${escapeHtml(msg)}</div></div>`;
  }

  let html=`<div class="ttable scroll-x" style="margin-bottom:12px;"><div class="muted" style="padding:6px 8px 0;">${dateDisplay}</div>`;
  if(hasGridContent){
    const head=activeCells.map(cell=>{
      const info=PERIODS[cell.period] || {};
      const label=getPeriodLabelLocal(cell.period);
      const time=info.time || '';
      return `<th class="nowrap">${escapeHtml(label)}<br><small class="muted">${escapeHtml(time)}</small></th>`;
    }).join('');
    const rows=activeCells.map(cell=>`<td class="cell">${cell.html || '<span class="muted">—</span>'}</td>`).join('');
    const weekdayHeading=escapeHtml(t('monitorTimetableWeekdayHeading'));
    const dateHeading=escapeHtml(t('thDate'));
    html+=`<table><thead><tr><th class="nowrap">${weekdayHeading}</th><th class="nowrap">${dateHeading}</th>${head}</tr></thead><tbody><tr><th class="nowrap">${weekdayText}</th><td class="muted nowrap">${dateText}</td>${rows}</tr></tbody></table>`;
  }
  if(hasOrphan){
    const labelText=hasGridContent ? t('monitorUnmatchedLabel') : t('monitorUnmatchedRecordsLabel');
    const labelHtml=`<strong>${escapeHtml(labelText)}</strong>`;
    html+=`<div class="cell" style="padding:8px;">${labelHtml}${orphanPieces.join('')}</div>`;
  }
  html+='</div>';
  return html;
}

const monDatesUI = {
  render(){ monDateChips.innerHTML=monDates.map(d=>`<span class="chip">${d}<button class="btn ghost" data-d="${d}">x</button></span>`).join(''); }
};
const markMonitorModified=()=>{ monitorDefaultActive=false; monitorUserModified=true; };
document.getElementById('btnAddMonDate').onclick=()=>{
  const d=monDatePicker.value;
  if(!d) return;
  markMonitorModified();
  if(!monDates.includes(d)){ monDates.push(d); monDates.sort(); }
  monDatesUI.render();
  buildMonitorView();
};
if(autoAddMonDate){
  autoAddMonDate.addEventListener('change',()=>{
    setBooleanPreferenceCookie(AUTO_ADD_MON_COOKIE, !!autoAddMonDate.checked);
  });
}
monDatePicker.addEventListener('change',()=>{
  if(autoAddMonDate && autoAddMonDate.checked){
    const d=monDatePicker.value;
    if(!d) return;
    markMonitorModified();
    if(!monDates.includes(d)){ monDates.push(d); monDates.sort(); }
    monDatesUI.render();
    buildMonitorView();
  }
});
btnAddMonRange.onclick=()=>{
  const a=monDatePickerStart.value, b=monDatePickerEnd.value; if(!a||!b){ alert(t('errorMonitorRange')); return; }
  const start=new Date(a+'T00:00:00'), end=new Date(b+'T00:00:00');
  if(start>end){ alert(t('errorRangeOrder')); return; }
  const cur=new Date(start);
  markMonitorModified();
  while(cur<=end){ const d=fmtDateYMDLocal(cur); if(!monDates.includes(d)) monDates.push(d); cur.setDate(cur.getDate()+1); }
  monDates.sort(); monDatesUI.render(); buildMonitorView();
};
monDateChips.addEventListener('click',e=>{ const b=e.target.closest('button[data-d]'); if(!b) return; const d=b.getAttribute('data-d'); markMonitorModified(); monDates=monDates.filter(x=>x!==d); monDatesUI.render(); buildMonitorView(); });

monTeacher.addEventListener('change',()=>{
  markMonitorModified();
  monitorTeacherPreference = monTeacher.value || '';
  setStringPreferenceCookie(MONITOR_TEACHER_COOKIE, monitorTeacherPreference);
  buildMonitorView();
});
monClass.addEventListener('change',()=>{
  markMonitorModified();
  monitorClassPreference = monClass.value || '';
  setStringPreferenceCookie(MONITOR_CLASS_COOKIE, monitorClassPreference);
  buildMonitorView();
});
monMode.addEventListener('change',()=>{ markMonitorModified(); buildMonitorView(); });
btnMonRefresh.onclick=buildMonitorView;

btnMonExport.onclick=async ()=>{
  if(!monDates.length){ alert(t('errorMonitorNeedDate')); return; }
  await loadMonitorRecordsFromCloud();
  const headerCells=[
    t('thDate'),
    t('monitorTablePeriodColumn'),
    t('thClass'),
    t('monitorTableGroupColumn'),
    t('monitorTableSubjectColumn'),
    t('monitorTableTeacherColumn'),
    t('monitorTableStudentsColumn')
  ];
  const headerLine=headerCells.map(s=>`"${(s||'').replace(/"/g,'""')}"`).join(',');
  let lines=[headerLine];
  monDates.forEach(d=>{
    const rows=buildMonitorRowsForDate(d);
    rows.forEach(r=>{
      const arr=[r.date,r.period||'',r.class||'',r.group||'',r.subject||'',r.teacher||'',r.students||''];
      lines.push(arr.map(s=>`"${(s||'').replace(/"/g,'""')}"`).join(','));
    });
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=t('monitorExportFilename'); a.click();
};

function activateStudentReason(target){
  if(!target) return;
  const name=decodeDatasetValue(target.dataset.student);
  const reason=decodeDatasetValue(target.dataset.reason);
  const department=decodeDatasetValue(target.dataset.department);
  showStudentReasonPanel(name, reason, department);
}

monResult.addEventListener('click',event=>{
  const item=event.target.closest('.student-item');
  if(!item) return;
  activateStudentReason(item);
});

monResult.addEventListener('keydown',event=>{
  if(event.key!=='Enter' && event.key!==' ') return;
  if(!(event.target instanceof HTMLElement)) return;
  if(!event.target.classList.contains('student-item')) return;
  event.preventDefault();
  activateStudentReason(event.target);
});

document.addEventListener('keydown',event=>{
  if(event.key==='Escape' && monReasonPanel && monReasonPanel.style.display!=='none'){
    hideReasonPanel();
  }
});

/***** —— Tab —— *****/
const tabMonitor=document.getElementById('tab-monitor');
const tabApply=document.getElementById('tab-apply');
const tabRecords=document.getElementById('tab-records');
const pageApply=document.getElementById('page-apply');
const pageRecords=document.getElementById('page-records');
const pageMonitor=document.getElementById('page-monitor');

const TAB_COOKIE_NAME='leave_active_tab';
const TAB_COOKIE_MAX_AGE=60*60*24*30; // 30 days

function readCookieValue(name){
  if(typeof document==='undefined' || !document.cookie) return null;
  const pairs=document.cookie.split(';');
  for(const pair of pairs){
    const [cookieName,...rest]=pair.trim().split('=');
    if(cookieName===name){
      return rest.join('=');
    }
  }
  return null;
}

function setBooleanPreferenceCookie(name,value){
  if(typeof document==='undefined') return;
  try{
    const raw=value?'1':'0';
    document.cookie=`${name}=${raw}; max-age=${TAB_COOKIE_MAX_AGE}; path=/; samesite=lax`;
  }catch(err){ /* ignore cookie errors */ }
}

function setStringPreferenceCookie(name,value){
  if(typeof document==='undefined') return;
  try{
    const normalized=value==null?'':String(value);
    const encoded=encodeURIComponent(normalized);
    document.cookie=`${name}=${encoded}; max-age=${TAB_COOKIE_MAX_AGE}; path=/; samesite=lax`;
  }catch(err){ /* ignore cookie errors */ }
}

function getBooleanCookie(name){
  const raw=readCookieValue(name);
  if(raw==null) return null;
  if(raw==='1') return true;
  if(raw==='0') return false;
  return null;
}

function getStringCookie(name){
  const raw=readCookieValue(name);
  if(raw==null) return null;
  try{
    return decodeURIComponent(raw);
  }catch(err){
    return raw;
  }
}

function normalizeTabKey(value){
  if(!value) return '';
  const key=String(value).toLowerCase();
  if(key==='monitor' || key==='apply' || key==='records') return key;
  return '';
}

function setTabCookie(value){
  const key=normalizeTabKey(value);
  if(!key || typeof document==='undefined') return;
  try{
    document.cookie=`${TAB_COOKIE_NAME}=${encodeURIComponent(key)}; max-age=${TAB_COOKIE_MAX_AGE}; path=/; samesite=lax`;
  }catch(err){ /* ignore cookie errors */ }
}

function getTabCookie(){
  const value=readCookieValue(TAB_COOKIE_NAME);
  if(!value) return '';
  try{ return normalizeTabKey(decodeURIComponent(value)); }
  catch(err){ return normalizeTabKey(value); }
}

async function setActiveTab(which){
  [tabApply,tabRecords,tabMonitor].forEach(t=>{
    t.classList.remove('active');
    t.setAttribute('aria-selected','false');
    t.tabIndex=-1;
  });
  [pageApply,pageRecords,pageMonitor].forEach(p=>p.style.display='none');
  if(which==='apply'){ tabApply.classList.add('active'); tabApply.setAttribute('aria-selected','true'); tabApply.tabIndex=0; pageApply.style.display='block'; }
  if(which==='records'){ tabRecords.classList.add('active'); tabRecords.setAttribute('aria-selected','true'); tabRecords.tabIndex=0; pageRecords.style.display='block'; refreshTable(); }
  if(which==='monitor'){
    tabMonitor.classList.add('active');
    tabMonitor.setAttribute('aria-selected','true');
    tabMonitor.tabIndex=0;
    pageMonitor.style.display='block';
    buildTeacherClassSelects();
    await ensureMonitorDefaults();
    if(monMode.value!=='timetable' && !monitorUserModified){
      monMode.value='timetable';
    }
    monitorDefaultActive = monitorDefaultActive && monMode.value==='timetable';
    await buildMonitorView();
  }
  setTabCookie(which);
}
tabApply.addEventListener('click',()=>setActiveTab('apply'));
tabRecords.addEventListener('click',()=>setActiveTab('records'));
tabMonitor.addEventListener('click',()=>setActiveTab('monitor'));
const allTabs=[tabMonitor,tabApply,tabRecords];
allTabs.forEach(tab=>{
  tab.addEventListener('keydown',event=>{
    if(event.key!=='ArrowRight' && event.key!=='ArrowLeft') return;
    event.preventDefault();
    const dir=event.key==='ArrowRight'?1:-1;
    const idx=allTabs.indexOf(tab);
    const next=allTabs[(idx+dir+allTabs.length)%allTabs.length];
    if(next){
      next.focus();
      const target=next.dataset.tab;
      if(target) setActiveTab(target);
    }
  });
});

onLanguageChange(()=>{
  try{ renderChips(); }catch(err){ console.warn('Failed to re-render chips after language change.',err); }
  try{ buildTeacherClassSelects(); }catch(err){ console.warn('Failed to rebuild teacher/class lists after language change.',err); }
  try{ updateConflict(); }catch(err){ console.warn('Failed to update conflict notice after language change.',err); }
  document.querySelectorAll('#tblBody button[data-idx]').forEach(btn=>{ btn.textContent=t('deleteRecords'); });
  if(pageMonitor && pageMonitor.style.display!=='none'){
    buildMonitorView();
  }
});

if(languageSelect){
  languageSelect.addEventListener('change',event=>{
    setLanguage(event.target.value);
  });
}

const initialTab=getTabCookie() || 'monitor';
setActiveTab(initialTab);
setLanguage(getCurrentLanguage(),{ persist:false });

// Supabase 核心数据在模块顶部通过 DOMContentLoaded 注册加载
</script>

</body>
</html>
